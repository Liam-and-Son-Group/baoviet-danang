<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | B·∫£o Hi·ªÉm B·∫£o Vi·ªát ƒê√† N·∫µng</title>
  <meta name="robots" content="noindex, nofollow">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Admin System Scripts -->
  <script src="supabase-config.js"></script>
  <script src="supabase-key-manager.js"></script>
  <script src="user-analytics.js"></script>
  <script src="admin-auth-manager.js"></script>
  <script src="admin-api-manager.js"></script>

  <style>
    :root {
      --sidebar-width: 280px;
      --sidebar-mobile-height: auto;
      --header-height: 60px;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --border-radius: 8px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1a202c;
      line-height: 1.6;
    }

    .dashboard-container {
      display: flex;
      min-height: 100vh;
    }

    /* Mobile Header */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: #2d3748;
      color: white;
      z-index: 1000;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--spacing-md);
      box-shadow: var(--shadow-sm);
    }

    .mobile-header-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .mobile-header-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .auth-btn {
      background: linear-gradient(135deg, #0060ae 0%, #0087d2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.4rem 0.8rem;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .auth-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 96, 174, 0.3);
    }

    .auth-btn.logout {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    }

    .hamburger-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: var(--spacing-sm);
      border-radius: 4px;
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Sidebar Overlay */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: #2d3748;
      color: white;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 2px 0 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      z-index: 1001;
      transition: transform 0.3s ease-in-out;
    }

    .sidebar-header {
      padding: 2rem 1.5rem;
      border-bottom: 1px solid #4a5568;
      text-align: center;
    }

    .sidebar-header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .sidebar-header p {
      color: #a0aec0;
      font-size: 0.875rem;
    }

    .sidebar-nav {
      padding: 1rem 0;
      flex: 1;
    }

    .nav-item {
      display: block;
      padding: 1rem 1.5rem;
      color: #e2e8f0;
      text-decoration: none;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      cursor: pointer;
    }

    .nav-item:hover {
      background: #4a5568;
      border-left-color: #0060ae;
    }

    .nav-item.active {
      background: #4a5568;
      border-left-color: #0060ae;
      color: white;
    }

    .nav-item i {
      margin-right: 0.75rem;
      width: 20px;
      text-align: center;
    }

    .sidebar-help {
      padding: 1rem 1.5rem;
      border-top: 1px solid #4a5568;
      margin-top: auto;
    }

    .help-btn {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 0.75rem 1rem;
      background: #4a5568;
      color: #a0aec0;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      transition: all 0.2s;
      text-align: left;
    }

    .help-btn:hover {
      background: #0060ae;
      color: white;
    }

    .help-btn i {
      margin-right: 0.75rem;
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      width: 100%;
      padding: 1rem 1.5rem;
      border-top: 1px solid #4a5568;
      margin-top: auto;
    }

    /* User Profile Styles */
    .user-profile {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .user-avatar {
      display: flex;
      justify-content: center;
    }

    .avatar-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .user-details {
      text-align: center;
      color: #a0aec0;
    }

    .user-name {
      font-size: 1rem;
      font-weight: 600;
      color: #f7fafc;
      margin-bottom: 0.25rem;
    }

    .user-email {
      font-size: 0.8rem;
      color: #a0aec0;
      margin-bottom: 0.125rem;
    }

    .user-role {
      font-size: 0.75rem;
      color: #68d391;
      text-transform: uppercase;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .user-actions {
      display: flex;
      gap: 0.5rem;
    }

    .profile-btn,
    .logout-btn {
      flex: 1;
      padding: 0.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .profile-btn {
      background: #4a5568;
      color: #a0aec0;
    }

    .profile-btn:hover {
      background: #2d3748;
      color: #f7fafc;
    }

    .logout-btn {
      background: #e53e3e;
      color: white;
    }

    .logout-btn:hover {
      background: #c53030;
    }

    .auth-signin {
      text-align: center;
    }

    .signin-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .signin-btn:hover {
      background: linear-gradient(135deg, #2563eb, #1e40af);
      transform: translateY(-1px);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #a0aec0;
      font-size: 0.875rem;
    }

    .logout-btn:hover {
      background: #c53030;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: var(--spacing-xl);
      transition: margin-left 0.3s ease-in-out;
    }

    .content-header {
      margin-bottom: 2rem;
    }

    .content-title {
      font-size: 2rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .content-subtitle {
      color: #718096;
      font-size: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #0060ae;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: #718096;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-icon {
      float: right;
      font-size: 2rem;
      opacity: 0.6;
    }

    /* Chart Section */
    .chart-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2d3748;
      margin: 0;
    }

    .chart-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .chart-btn {
      padding: 0.5rem 1rem;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      color: #4a5568;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-btn:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }

    .chart-btn.active {
      background: #0060ae;
      border-color: #0060ae;
      color: white;
    }

    /* Registration Chart Buttons */
    .registration-chart-btn {
      padding: 0.5rem 1rem;
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      color: #4a5568;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .registration-chart-btn:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }

    .registration-chart-btn.active {
      background: #38a169;
      border-color: #38a169;
      color: white;
    }

    .chart-container {
      position: relative;
      height: 300px;
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
    }

    #articlesChart {
      width: 100% !important;
      height: 100% !important;
    }

    .chart-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.9);
      color: #4a5568;
      font-size: 0.875rem;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-top: 3px solid #0060ae;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 0.5rem;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .content-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #2d3748;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: #0060ae;
      color: white;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-success:hover {
      background: #38a169;
    }

    .btn-danger {
      background: #e53e3e;
      color: white;
    }

    .btn-danger:hover {
      background: #c53030;
    }

    .btn-secondary {
      background: #edf2f7;
      color: #4a5568;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 12px;
    }

    .data-table th,
    .data-table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .data-table th:nth-child(3),
    .data-table td:nth-child(3) {
      width: 120px;
      text-align: center;
    }

    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
      width: 120px;
      text-align: center;
    }

    /* Table action buttons */
    .data-table .btn {
      padding: 0.375rem 0.75rem;
      font-size: 11px;
      margin: 0.125rem;
    }

    .data-table th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .data-table tr:hover {
      background: #f7fafc;
    }

    .status-badge {
      padding: 0.375rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .status-draft {
      background: #fef3c7;
      color: #92400e;
    }

    .status-published {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pending {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Status Messages */
    .status-message {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }

    .status-success {
      background: #f0fff4;
      color: #22543d;
      border: 1px solid #c6f6d5;
    }

    .status-error {
      background: #fff5f5;
      color: #742a2a;
      border: 1px solid #fed7d7;
    }

    .status-info {
      background: #ebf8ff;
      color: #0056b3;
      border: 1px solid #bee3f8;
    }

    /* Loading States */
    .loading {
      text-align: center;
      padding: 2rem;
      color: #718096;
    }

    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-radius: 50%;
      border-top-color: #0060ae;
      animation: spin 1s ease-in-out infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Google Search Console Section */
    .search-console-section {
      margin-bottom: 2rem;
    }

    .search-console-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 2rem;
      color: white;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }

    .search-console-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: translate(30px, -30px);
    }

    .search-console-header {
      display: flex;
      align-items: flex-start;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .search-console-icon {
      font-size: 3rem;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
    }

    .search-console-content {
      flex: 1;
    }

    .search-console-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .search-console-description {
      font-size: 1rem;
      line-height: 1.6;
      margin: 0;
      opacity: 0.95;
    }

    .search-console-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .feature-icon {
      font-size: 1.25rem;
    }

    .search-console-action {
      text-align: center;
    }

    .btn-console {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      background: linear-gradient(135deg, #ff6b35 0%, #f39c12 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1rem;
      border: 2px solid rgba(255, 255, 255, 0.4);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .btn-console:hover {
      background: linear-gradient(135deg, #e55a2b 0%, #e67e22 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 53, 0.6);
      color: white;
      text-decoration: none;
      border-color: rgba(255, 255, 255, 0.6);
    }

    /* Analytics Section */
    .analytics-section {
      margin: 2rem 0;
      padding: 2rem;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 20px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    .analytics-section .section-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .analytics-section .section-header h2 {
      color: #1f2937;
      margin-bottom: 0.5rem;
      font-size: 2rem;
      font-weight: 700;
    }

    .analytics-section .section-header p {
      color: #64748b;
      font-size: 1.1rem;
      margin: 0;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .analytics-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .analytics-card .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .analytics-card .card-header h3 {
      margin: 0;
      color: #1f2937;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .period-selector {
      padding: 0.25rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: white;
      font-size: 0.9rem;
      color: #374151;
    }

    .period-badge {
      background: #10b981;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .live-indicator {
      background: #ef4444;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .realtime-stat {
      text-align: center;
      margin-bottom: 1rem;
    }

    .stat-number {
      display: block;
      font-size: 2.5rem;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      display: block;
      color: #64748b;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .live-pages-list {
      max-height: 150px;
      overflow-y: auto;
    }

    .live-page-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: #f1f5f9;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .live-page-title {
      flex: 1;
      color: #374151;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .live-page-count {
      background: #3b82f6;
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .analytics-table {
      max-height: 300px;
      overflow-y: auto;
    }

    .table-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-cell-title {
      flex: 1;
      color: #374151;
      font-weight: 500;
      font-size: 0.9rem;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .table-cell-value {
      color: #10b981;
      font-weight: 600;
      font-size: 0.9rem;
      margin-left: 1rem;
    }

    .keywords-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
      min-height: 150px;
    }

    .keyword-tag {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      transition: all 0.2s ease;
    }

    .keyword-tag:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }

    .keyword-frequency {
      background: rgba(255, 255, 255, 0.3);
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.7rem;
      margin-left: 0.3rem;
    }

    .traffic-sources-list {
      margin-top: 1rem;
    }

    .traffic-source-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .traffic-source-item:last-child {
      border-bottom: none;
    }

    .traffic-source-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #374151;
      font-weight: 500;
    }

    .traffic-source-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .source-google {
      background: #ea4335;
    }

    .source-facebook {
      background: #1877f2;
    }

    .source-direct {
      background: #64748b;
    }

    .source-other {
      background: #10b981;
    }

    .traffic-source-stats {
      text-align: right;
    }

    .traffic-source-visits {
      color: #10b981;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .traffic-source-percentage {
      color: #64748b;
      font-size: 0.8rem;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .summary-stat {
      text-align: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .summary-stat .stat-value {
      display: block;
      font-size: 1.8rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }

    .summary-stat .stat-label {
      display: block;
      color: #64748b;
      font-size: 0.8rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .analytics-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-style: italic;
      min-height: 100px;
    }

    .loading::before {
      flex-shrink: 0;
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn-icon {
      font-size: 1.2rem;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    /* Tablet Styles */
    @media (max-width: 1024px) {
      :root {
        --sidebar-width: 250px;
      }

      .main-content {
        padding: var(--spacing-lg);
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
      }

      .help-modal-content {
        width: 95%;
      }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
      .mobile-header {
        display: flex;
      }

      .sidebar {
        transform: translateX(-100%);
        width: 280px;
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
      }

      .sidebar.mobile-open {
        transform: translateX(0);
      }

      .sidebar-overlay.show {
        display: block;
      }

      .main-content {
        margin-left: 0;
        padding: var(--spacing-md);
        padding-top: calc(var(--header-height) + var(--spacing-md));
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
      }

      .stat-card {
        padding: var(--spacing-md);
      }

      /* Chart responsive for tablet */
      .chart-header {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-md);
      }

      .chart-controls {
        justify-content: center;
      }

      .chart-container {
        height: 250px;
      }

      .quick-actions {
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .quick-actions .btn {
        width: 100%;
        text-align: center;
      }

      /* Content sections responsive */
      .content-header {
        text-align: center;
        margin-bottom: var(--spacing-lg);
      }

      .content-title {
        font-size: 1.5rem;
      }

      .section-header {
        flex-direction: column;
        gap: var(--spacing-md);
        text-align: center;
      }

      /* Table responsive */
      .data-table {
        font-size: 0.875rem;
      }

      .data-table th,
      .data-table td {
        padding: 0.5rem 0.25rem;
      }

      .data-table .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }

      /* Sidebar responsive */
      .sidebar-header {
        padding: var(--spacing-lg) var(--spacing-md);
      }

      .sidebar-header h1 {
        font-size: 1.1rem;
      }

      .nav-item {
        padding: 0.875rem var(--spacing-md);
        font-size: 0.9rem;
      }

      .sidebar-help {
        padding: var(--spacing-md);
      }

      .sidebar-footer {
        padding: var(--spacing-md);
      }

      /* Search Console responsive for tablet */
      .search-console-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }

      .search-console-features {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Small Mobile Styles */
    @media (max-width: 480px) {
      .main-content {
        padding: var(--spacing-sm);
        padding-top: calc(var(--header-height) + var(--spacing-sm));
        width: 100%;
      }

      .welcome-section {
        padding: var(--spacing-lg);
        text-align: center;
      }

      .welcome-title {
        font-size: 1.4rem;
      }

      .stats-grid {
        gap: 0.75rem;
      }

      .stat-number {
        font-size: 1.5rem;
      }

      /* Chart responsive for small mobile */
      .chart-btn {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
      }

      .chart-container {
        height: 200px;
      }

      .chart-title {
        font-size: 1rem;
      }

      /* Search Console responsive */
      .search-console-card {
        padding: 1.5rem;
      }

      .search-console-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }

      .search-console-icon {
        font-size: 2.5rem;
      }

      .search-console-title {
        font-size: 1.25rem;
      }

      .search-console-features {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }

      .feature-item {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
      }

      .btn-console {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
      }

      .data-table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .help-modal-content {
        width: 98%;
        margin: var(--spacing-sm);
      }

      .help-modal-header {
        padding: var(--spacing-md);
      }

      .help-content {
        padding: var(--spacing-md);
      }

      /* Mobile table improvements */
      .data-table {
        font-size: 10px;
      }

      .data-table th,
      .data-table td {
        padding: 0.5rem 0.25rem;
        min-width: 80px;
      }

      .data-table .btn {
        padding: 0.25rem 0.5rem;
        font-size: 9px;
        margin: 0.1rem;
      }

      /* Hide less important columns on mobile */
      .data-table th:nth-child(4),
      .data-table td:nth-child(4) {
        display: none;
      }

      /* Stack action buttons vertically on very small screens */
      .data-table td .btn {
        display: block;
        margin: 0.1rem 0;
        text-align: center;
      }

      /* Welcome section responsive */
      .welcome-section {
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .welcome-title {
        font-size: 1.25rem;
      }

      .welcome-text {
        font-size: 0.875rem;
      }

      .welcome-notification {
        padding: 0.75rem;
        margin: 0.5rem 0;
      }
    }

    .welcome-section {
      background: linear-gradient(135deg, #0060ae 0%, #0087d2 100%);
      color: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .welcome-title {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .welcome-text {
      opacity: 0.9;
      font-size: 1rem;
    }

    /* Welcome notification */
    .welcome-notification {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      backdrop-filter: blur(10px);
      animation: welcomeSlideIn 0.6s ease-out;
      text-align: left;
    }

    .notification-icon {
      font-size: 2rem;
      animation: waveHand 2s ease-in-out infinite;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .notification-message {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .notification-close {
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      margin-left: 0.5rem;
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: scale(1.1);
    }

    @keyframes welcomeSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
        scale: 0.95;
      }

      to {
        opacity: 1;
        transform: translateY(0);
        scale: 1;
      }
    }

    @keyframes waveHand {

      0%,
      100% {
        transform: rotate(0deg);
      }

      10%,
      30%,
      50%,
      70% {
        transform: rotate(-10deg);
      }

      20%,
      40%,
      60% {
        transform: rotate(10deg);
      }
    }

    /* Responsive welcome notification */
    @media (max-width: 768px) {
      .welcome-notification {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }

      .notification-icon {
        font-size: 1.5rem;
        align-self: center;
      }

      .notification-close {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
      }

      .welcome-notification {
        position: relative;
        padding: 1.5rem 2rem 1rem 1rem;
      }
    }

    /* Pagination Styles */
    .pagination-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 2rem;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .pagination-info {
      color: #718096;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pagination-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #e2e8f0;
      background: white;
      color: #4a5568;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .pagination-btn:hover:not(:disabled) {
      background: #f7fafc;
      border-color: #cbd5e0;
      transform: translateY(-1px);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f7fafc;
    }

    .page-numbers {
      display: flex;
      gap: 0.25rem;
      margin: 0 0.5rem;
    }

    .page-number {
      padding: 0.5rem 0.75rem;
      border: 1px solid #e2e8f0;
      background: white;
      color: #4a5568;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      min-width: 40px;
      text-align: center;
    }

    .page-number:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }

    .page-number.active {
      background: #0060ae;
      color: white;
      border-color: #0060ae;
    }

    .page-number.ellipsis {
      cursor: default;
      background: transparent;
      border: none;
      color: #a0aec0;
    }

    .page-number.ellipsis:hover {
      background: transparent;
      border: none;
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #718096;
      font-size: 0.9rem;
    }

    .page-size-selector select {
      padding: 0.375rem 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: white;
      color: #4a5568;
      font-size: 0.875rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .page-size-selector select:focus {
      outline: none;
      border-color: #0060ae;
      box-shadow: 0 0 0 3px rgba(0, 96, 174, 0.1);
    }

    /* Responsive pagination */
    @media (max-width: 768px) {
      .pagination-container {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
      }

      .pagination-controls {
        justify-content: center;
      }

      .pagination-info,
      .page-size-selector {
        text-align: center;
      }

      .page-numbers {
        justify-content: center;
      }

      .pagination-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }
    }

    /* Loading skeleton for stats */
    .stat-number.loading {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading-shimmer 1.5s infinite;
      color: transparent;
      border-radius: 4px;
      min-height: 2rem;
    }

    @keyframes loading-shimmer {
      0% {
        background-position: -200% 0;
      }

      100% {
        background-position: 200% 0;
      }
    }

    /* Table loading shimmer */
    .loading-shimmer {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading-shimmer 1.5s infinite;
      border-radius: 4px;
    }

    /* Performance optimization */
    .stat-card {
      will-change: transform;
    }

    .content-section {
      will-change: transform;
    }

    /* Optimize table rendering */
    .data-table {
      contain: layout style paint;
    }

    .data-table tbody tr {
      contain: layout style;
    }

    /* Help Modal Styles */
    .help-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .help-modal-content {
      background: white;
      border-radius: 12px;
      max-width: 900px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
      display: flex;
      flex-direction: column;
    }

    .help-modal-header {
      background: linear-gradient(135deg, #0060ae 0%, #0087d2 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .help-modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .help-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .help-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .help-modal-body {
      padding: 0;
      overflow-y: auto;
      flex: 1;
    }

    .help-nav {
      display: flex;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
    }

    .help-nav-item {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
      color: #718096;
    }

    .help-nav-item:hover {
      background: #edf2f7;
      color: #4a5568;
    }

    .help-nav-item.active {
      color: #0060ae;
      border-bottom-color: #0060ae;
      background: white;
    }

    .help-content {
      padding: 2rem;
      line-height: 1.6;
    }

    .help-section {
      display: none;
    }

    .help-section.active {
      display: block;
    }

    .help-section h3 {
      color: #2d3748;
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e2e8f0;
    }

    .help-section h4 {
      color: #4a5568;
      font-size: 1.1rem;
      margin: 1.5rem 0 0.75rem 0;
    }

    .help-section p,
    .help-section li {
      color: #718096;
      margin-bottom: 0.75rem;
    }

    .help-section ul {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .help-feature {
      background: #f7fafc;
      border-left: 4px solid #0060ae;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 6px 6px 0;
    }

    .help-feature-title {
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .help-step {
      background: #edf2f7;
      padding: 1rem;
      border-radius: 6px;
      margin: 0.75rem 0;
      border-left: 3px solid #4299e1;
    }

    .help-warning {
      background: #fef5e7;
      border: 1px solid #f6ad55;
      border-radius: 6px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .help-warning-title {
      color: #c05621;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .help-code {
      background: #2d3748;
      color: #e2e8f0;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }

    .help-shortcut {
      display: inline-flex;
      align-items: center;
      background: #edf2f7;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      margin: 0 0.25rem;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive help modal */
    @media (max-width: 768px) {
      .help-modal-content {
        width: 95%;
        max-height: 90vh;
      }

      .help-nav {
        flex-wrap: wrap;
      }

      .help-nav-item {
        flex: 1;
        text-align: center;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
      }

      .help-content {
        padding: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <div class="mobile-header-title">
      <span>üè¢</span>
      <span>Admin Panel</span>
    </div>
    <div class="mobile-header-actions">
      <button id="adminAuthBtn" class="auth-btn" onclick="handleAuthAction()">
        <span id="authBtnText">üîê ƒêƒÉng nh·∫≠p</span>
      </button>
      <button class="hamburger-btn" onclick="toggleMobileSidebar()">‚ò∞</button>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>üè¢ Admin Panel</h1>
        <p>B·∫£o Hi·ªÉm B·∫£o Vi·ªát ƒê√† N·∫µng</p>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-section="overview">
          üìä
          T·ªïng quan
        </a>
        <a href="#" class="nav-item" data-section="articles">
          üìù
          Qu·∫£n l√Ω b√†i vi·∫øt
        </a>
        <a href="#" class="nav-item" data-section="users">
          üë•
          Qu·∫£n l√Ω ng∆∞·ªùi ƒëƒÉng k√Ω
        </a>
        <a href="#" class="nav-item" data-section="compose">
          ‚úçÔ∏è
          ƒêƒÉng b√†i m·ªõi
        </a>
      </nav>

      <div class="sidebar-help">
        <button class="help-btn" onclick="showHelpModal()">
          <i>‚ùì</i>
          Tr·ª£ gi√∫p
        </button>
      </div>

      <div class="sidebar-footer">
        <!-- User Profile Section -->
        <div class="user-profile auth-required" style="display: none;">
          <div class="user-avatar">
            <div class="avatar-circle">
              <span class="user-initials">AD</span>
            </div>
          </div>
          <div class="user-details">
            <div class="user-name">Loading...</div>
            <div class="user-email">user@domain.com</div>
            <div class="user-role">admin</div>
          </div>
          <div class="user-actions">
            <button class="profile-btn" onclick="showUserProfile()" title="User Profile">
              ‚öôÔ∏è Settings
            </button>
            <button class="logout-btn" onclick="handleSupabaseLogout()" title="Sign Out">
              üö™ Logout
            </button>
          </div>
        </div>

        <!-- Auth Required Section -->
        <!-- <div class="auth-signin auth-hidden">
          <button class="signin-btn" onclick="showSupabaseAuth()">
            üîê Sign In Required
          </button>
        </div> -->
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div id="statusMessage" class="status-message"></div>

      <!-- Overview Section -->
      <section id="overview" class="content-section active">
        <div class="welcome-section">
          <h2 class="welcome-title" id="welcomeTitle">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Admin Panel</h2>
          <p class="welcome-text" id="welcomeText">Qu·∫£n l√Ω website B·∫£o Hi·ªÉm B·∫£o Vi·ªát ƒê√† N·∫µng</p>

          <!-- Welcome back notification -->
          <div id="welcomeBackNotification" class="welcome-notification" style="display: none;">
            <div class="notification-icon">üëã</div>
            <div class="notification-content">
              <div class="notification-title">Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!</div>
              <div class="notification-message">H·ªá th·ªëng ƒë√£ s·∫µn s√†ng ƒë·ªÉ b·∫°n qu·∫£n l√Ω n·ªôi dung</div>
            </div>
            <button class="notification-close" onclick="hideWelcomeNotification()" title="ƒê√≥ng th√¥ng b√°o">
              √ó
            </button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-number" id="totalArticles">-</div>
            <div class="stat-label">T·ªïng b√†i vi·∫øt</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-number" id="publishedArticles">-</div>
            <div class="stat-label">ƒê√£ xu·∫•t b·∫£n</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìÑ</div>
            <div class="stat-number" id="draftArticles">-</div>
            <div class="stat-label">B√†i nh√°p</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-number" id="totalUsers">-</div>
            <div class="stat-label">Ng∆∞·ªùi ƒëƒÉng k√Ω</div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-section">
          <div class="chart-header">
            <h3 class="chart-title">üìà TƒÉng tr∆∞·ªüng b√†i vi·∫øt</h3>
            <div class="chart-controls">
              <button class="chart-btn active" data-period="15" onclick="changeChartPeriod(15)">15 ng√†y</button>
              <button class="chart-btn" data-period="30" onclick="changeChartPeriod(30)">1 th√°ng</button>
              <button class="chart-btn" data-period="90" onclick="changeChartPeriod(90)">3 th√°ng</button>
              <button class="chart-btn" data-period="365" onclick="changeChartPeriod(365)">1 nƒÉm</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="articlesChart" width="400" height="200"></canvas>
            <div class="chart-loading" id="chartLoading" style="display: none;">
              <div class="loading-spinner"></div>
              <div>ƒêang t·∫£i bi·ªÉu ƒë·ªì...</div>
            </div>
          </div>
        </div>

        <!-- User Registration Chart Section -->
        <div class="chart-section">
          <div class="chart-header">
            <h3 class="chart-title">üë• Th·ªëng k√™ ƒëƒÉng k√Ω theo d·ªãch v·ª•</h3>
            <div class="chart-controls">
              <button class="registration-chart-btn active" data-period="30"
                onclick="changeRegistrationChartPeriod(30)">1 th√°ng</button>
              <button class="registration-chart-btn" data-period="90" onclick="changeRegistrationChartPeriod(90)">3
                th√°ng</button>
              <button class="registration-chart-btn" data-period="180" onclick="changeRegistrationChartPeriod(180)">6
                th√°ng</button>
              <button class="registration-chart-btn" data-period="365" onclick="changeRegistrationChartPeriod(365)">1
                nƒÉm</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="registrationChart" width="400" height="200"></canvas>
            <div class="chart-loading" id="registrationChartLoading" style="display: none;">
              <div class="loading-spinner"></div>
              <div>ƒêang t·∫£i th·ªëng k√™ ƒëƒÉng k√Ω...</div>
            </div>
          </div>
        </div>

        <!-- Google Search Console Section -->
        <div class="search-console-section">
          <div class="search-console-card">
            <div class="search-console-header">
              <div class="search-console-icon">üîç</div>
              <div class="search-console-content">
                <h3 class="search-console-title">Ph√¢n t√≠ch th·ª© h·∫°ng trang web</h3>
                <p class="search-console-description">
                  B·∫°n mu·ªën xem th·ª© h·∫°ng c·ªßa trang web hay nh·ªØng trang n√†o ƒëang l√™n Up trend ho·∫∑c Down trend?
                  H√£y truy c·∫≠p Google Search Console c·ªßa h·ªá th·ªëng ƒë·ªÉ xem chi ti·∫øt.
                </p>
              </div>
            </div>
            <div class="search-console-features">
              <div class="feature-item">
                <span class="feature-icon">üìä</span>
                <span>Theo d√µi th·ª© h·∫°ng t·ª´ kh√≥a</span>
              </div>
              <div class="feature-item">
                <span class="feature-icon">üìà</span>
                <span>Ph√¢n t√≠ch xu h∆∞·ªõng tƒÉng tr∆∞·ªüng</span>
              </div>
              <div class="feature-item">
                <span class="feature-icon">üìâ</span>
                <span>Ph√°t hi·ªán trang ƒëang suy gi·∫£m</span>
              </div>
              <div class="feature-item">
                <span class="feature-icon">üéØ</span>
                <span>T·ªëi ∆∞u hi·ªáu su·∫•t SEO</span>
              </div>
            </div>
            <div class="search-console-action">
              <a href="https://search.google.com/u/1/search-console?resource_id=sc-domain%3Abaohiembaovietdanang.vn"
                target="_blank" class="btn btn-console">
                <span class="btn-icon">üöÄ</span>
                Truy c·∫≠p ngay
              </a>
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <a href="#" class="btn btn-primary" onclick="switchSection('compose')">
            ‚úçÔ∏è ƒêƒÉng b√†i m·ªõi
          </a>
          <a href="#" class="btn btn-success" onclick="switchSection('articles')">
            üìù Qu·∫£n l√Ω b√†i vi·∫øt
          </a>
          <a href="#" class="btn btn-secondary" onclick="switchSection('users')">
            üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng
          </a>
        </div>
      </section>

      <!-- Articles Section -->
      <section id="articles" class="content-section">
        <div class="content-header">
          <h2 class="content-title">Qu·∫£n l√Ω b√†i vi·∫øt</h2>
          <p class="content-subtitle">Xem, ch·ªânh s·ª≠a v√† qu·∫£n l√Ω t·∫•t c·∫£ b√†i vi·∫øt</p>
        </div>

        <div class="section-header">
          <h3 class="section-title">Danh s√°ch b√†i vi·∫øt</h3>
          <button class="btn btn-primary" onclick="refreshArticles()">
            üîÑ L√†m m·ªõi
          </button>
        </div>

        <div id="articlesLoading" class="loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p>ƒêang t·∫£i danh s√°ch b√†i vi·∫øt...</p>
        </div>

        <div id="articlesTable"></div>

        <!-- Pagination Controls -->
        <div id="articlesPagination" class="pagination-container" style="display: none;">
          <div class="pagination-info">
            <span id="articlesPageInfo">Hi·ªÉn th·ªã 1-10 c·ªßa 50 b√†i vi·∫øt</span>
          </div>
          <div class="pagination-controls">
            <button id="articlesFirstPage" class="pagination-btn" onclick="goToArticlesPage(1)">
              ‚èÆÔ∏è ƒê·∫ßu
            </button>
            <button id="articlesPrevPage" class="pagination-btn"
              onclick="goToArticlesPage(Math.max(1, currentArticlesPage - 1))">
              ‚¨ÖÔ∏è Tr∆∞·ªõc
            </button>
            <div id="articlesPageNumbers" class="page-numbers">
              <!-- Page numbers will be generated here -->
            </div>
            <button id="articlesNextPage" class="pagination-btn"
              onclick="goToArticlesPage(Math.min(totalArticlesPages || 1, currentArticlesPage + 1))">
              Sau ‚û°Ô∏è
            </button>
            <button id="articlesLastPage" class="pagination-btn" onclick="goToArticlesPage(totalArticlesPages || 1)">
              Cu·ªëi ‚è≠Ô∏è
            </button>
          </div>
          <div class="page-size-selector">
            <label for="articlesPageSize">Hi·ªÉn th·ªã:</label>
            <select id="articlesPageSize" onchange="changeArticlesPageSize(this.value)">
              <option value="10">10</option>
              <option value="20">20</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>b√†i vi·∫øt/trang</span>
          </div>
        </div>
      </section>

      <!-- Users Section -->
      <section id="users" class="content-section">
        <div class="content-header">
          <h2 class="content-title">Qu·∫£n l√Ω ng∆∞·ªùi ƒëƒÉng k√Ω</h2>
          <p class="content-subtitle">Xem v√† qu·∫£n l√Ω danh s√°ch ng∆∞·ªùi ƒëƒÉng k√Ω d·ªãch v·ª•</p>
        </div>

        <div class="section-header">
          <h3 class="section-title">Danh s√°ch ng∆∞·ªùi ƒëƒÉng k√Ω</h3>
          <button class="btn btn-primary" onclick="refreshUsers()">
            üîÑ L√†m m·ªõi
          </button>
        </div>

        <div id="usersLoading" class="loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p>ƒêang t·∫£i danh s√°ch ng∆∞·ªùi ƒëƒÉng k√Ω...</p>
        </div>

        <div id="usersTable"></div>
      </section>

      <!-- Compose Section -->
      <section id="compose" class="content-section">
        <div class="content-header">
          <h2 class="content-title">ƒêƒÉng b√†i m·ªõi</h2>
          <p class="content-subtitle">T·∫°o v√† xu·∫•t b·∫£n b√†i vi·∫øt m·ªõi</p>
        </div>

        <div style="text-align: center; padding: 2rem;">
          <p style="margin-bottom: 1rem; color: #718096;">Chuy·ªÉn ƒë·∫øn trang so·∫°n th·∫£o ƒë·ªÉ t·∫°o b√†i vi·∫øt m·ªõi</p>
          <a href="admin-compose-e8d6c754705d3fce.html" class="btn btn-primary">
            ‚úçÔ∏è M·ªü tr√¨nh so·∫°n th·∫£o
          </a>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Initialize variables
    // Helper function to get supabase client
    function getSupabaseClient() {
      if (window.supabaseClient) {
        return window.supabaseClient;
      }
      if (adminAuth && typeof adminAuth.getSupabaseClient === 'function') {
        const client = adminAuth.getSupabaseClient();
        if (client) {
          window.supabaseClient = client;
          return client;
        }
      }
      return null;
    }

    // Supabase client variable (will be set when auth is ready)
    // Using different name to avoid conflict with Supabase CDN global
    let supabaseClient = null;

    // Helper to get supabase client (backward compatibility)
    function getSupabase() {
      return supabaseClient || window.supabaseClient || getSupabaseClient();
    }

    let currentSection = 'overview';

    // Pagination variables for articles
    let currentArticlesPage = 1;
    let articlesPerPage = 10;
    let totalArticles = 0;
    let totalArticlesPages = 0;

    // Cache variables to avoid unnecessary reloads
    let overviewStatsCache = null;
    let overviewStatsCacheTime = 0;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // Chart variables
    let articlesChart = null;
    let currentChartPeriod = 15;
    let chartDataCache = new Map();

    // Registration chart variables
    let registrationChart = null;
    let currentRegistrationChartPeriod = 30;
    let registrationChartDataCache = new Map();

    // Debounce variables
    let switchSectionTimeout = null;

    // Initialize app
    window.addEventListener('DOMContentLoaded', async function () {
      showWelcomeBackNotification();
      await initializeAdminAuth();
    });

    // Legacy checkAuth function - removed redirect logic
    function checkAuth() {
      // No longer redirect - handled by new auth system
      console.log('üîÑ Auth check - handled by AdminAuthManager');
    }

    function showWelcomeBackNotification() {
      const notification = document.getElementById('welcomeBackNotification');
      const loginTime = parseInt(sessionStorage.getItem('admin_login_time') || '0');
      const currentTime = Date.now();
      const timeSinceLogin = currentTime - loginTime;

      // Show welcome back message if login was recent (within 5 seconds)
      // This indicates they just logged in
      if (timeSinceLogin < 5000) {
        // Get current time for personalized greeting
        const now = new Date();
        const hour = now.getHours();
        let timeGreeting = 'Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!';

        if (hour >= 5 && hour < 12) {
          timeGreeting = 'Ch√†o bu·ªïi s√°ng! Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!';
        } else if (hour >= 12 && hour < 17) {
          timeGreeting = 'Ch√†o bu·ªïi chi·ªÅu! Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!';
        } else if (hour >= 17 && hour < 22) {
          timeGreeting = 'Ch√†o bu·ªïi t·ªëi! Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!';
        } else {
          timeGreeting = 'Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!';
        }

        // Update notification content
        const notificationTitle = notification.querySelector('.notification-title');
        const notificationMessage = notification.querySelector('.notification-message');

        if (notificationTitle) {
          notificationTitle.textContent = timeGreeting;
        }

        // Add last login info if available
        const lastLoginTime = sessionStorage.getItem('admin_last_access_time');
        if (lastLoginTime && notificationMessage) {
          const lastLogin = new Date(parseInt(lastLoginTime));
          const timeAgo = getTimeAgo(lastLogin);
          notificationMessage.textContent = `L·∫ßn truy c·∫≠p cu·ªëi: ${timeAgo}. H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!`;
        }

        // Show notification
        notification.style.display = 'flex';

        // Auto hide after 5 seconds
        setTimeout(() => {
          notification.style.opacity = '0';
          setTimeout(() => {
            notification.style.display = 'none';
            notification.style.opacity = '1'; // Reset for next time
          }, 300);
        }, 5000);

        // Store current time as last access time for next login
        sessionStorage.setItem('admin_last_access_time', currentTime.toString());
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'v·ª´a xong';
      if (diffMins < 60) return `${diffMins} ph√∫t tr∆∞·ªõc`;
      if (diffHours < 24) return `${diffHours} gi·ªù tr∆∞·ªõc`;
      if (diffDays < 7) return `${diffDays} ng√†y tr∆∞·ªõc`;

      return date.toLocaleDateString('vi-VN');
    }

    function hideWelcomeNotification() {
      const notification = document.getElementById('welcomeBackNotification');
      notification.style.opacity = '0';
      setTimeout(() => {
        notification.style.display = 'none';
        notification.style.opacity = '1'; // Reset for next time
      }, 300);
    }

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        const section = this.dataset.section;
        switchSection(section);
      });
    });

    function switchSection(section) {
      // Prevent multiple rapid calls
      if (switchSectionTimeout) {
        clearTimeout(switchSectionTimeout);
      }

      // Auto close mobile sidebar when switching sections
      closeMobileSidebar();

      // Update nav immediately for responsiveness
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-section="${section}"]`)?.classList.add('active');

      // Update content immediately
      document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
      });
      document.getElementById(section)?.classList.add('active');

      currentSection = section;

      // Debounce data loading
      switchSectionTimeout = setTimeout(() => {
        // Load section data only after UI update
        if (section === 'articles') {
          currentArticlesPage = 1; // Reset to first page when switching to articles
          loadArticles(1);
        } else if (section === 'users') {
          loadUsers();
        } else if (section === 'overview') {
          loadOverviewStats();
        }
        switchSectionTimeout = null;
      }, 100); // Small delay to ensure smooth UI transition
    }

    // Overview stats
    async function loadOverviewStats(forceRefresh = false) {
      const supabase = getSupabase();
      if (!supabase) return;

      // Check cache first
      const now = Date.now();
      if (!forceRefresh && overviewStatsCache && (now - overviewStatsCacheTime) < CACHE_DURATION) {
        updateOverviewStatsUI(overviewStatsCache);
        return;
      }

      // Show loading state
      showStatsLoading();

      // Load charts in parallel - don't wait for stats
      loadChart(currentChartPeriod, forceRefresh);
      loadRegistrationChart(currentRegistrationChartPeriod, forceRefresh);

      try {
        // Use count queries for better performance
        const [articlesCount, publishedCount, draftCount, usersCount] = await Promise.all([
          // Total articles count
          supabase
            .from('articles')
            .select('*', { count: 'exact', head: true }),

          // Published articles count
          supabase
            .from('articles')
            .select('*', { count: 'exact', head: true })
            .or('is_published.eq.true,status.eq.published'),

          // Draft articles count
          supabase
            .from('articles')
            .select('*', { count: 'exact', head: true })
            .or('is_published.eq.false,status.eq.draft'),

          // Users count
          supabase
            .from('registrations')
            .select('*', { count: 'exact', head: true })
        ]);

        // Prepare cache data
        const statsData = {
          totalArticles: !articlesCount.error ? (articlesCount.count || 0) : 0,
          publishedArticles: !publishedCount.error ? (publishedCount.count || 0) : 0,
          draftArticles: !draftCount.error ? (draftCount.count || 0) : 0,
          totalUsers: !usersCount.error ? (usersCount.count || 0) : 0
        };

        // Update cache
        overviewStatsCache = statsData;
        overviewStatsCacheTime = Date.now();

        // Update UI
        updateOverviewStatsUI(statsData);

      } catch (error) {
        console.error('Error loading overview stats:', error);
        // Set fallback values
        const fallbackData = {
          totalArticles: '---',
          publishedArticles: '---',
          draftArticles: '---',
          totalUsers: '---'
        };
        updateOverviewStatsUI(fallbackData);
      }
    }

    function updateOverviewStatsUI(data, isLoading = false) {
      const elements = ['totalArticles', 'publishedArticles', 'draftArticles', 'totalUsers'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          if (isLoading) {
            element.classList.add('loading');
            element.textContent = '---';
          } else {
            element.classList.remove('loading');
            element.textContent = data[id];
          }
        }
      });
    }

    function showStatsLoading() {
      updateOverviewStatsUI({}, true);
    }

    // Articles management with caching
    let articlesCache = new Map();
    let articlesCacheTime = new Map();
    const ARTICLES_CACHE_DURATION = 2 * 60 * 1000; // 2 minutes cache
    let prefetchTimeout = null;

    async function loadArticles(page = 1) {
      const supabase = getSupabase();
      if (!supabase) {
        showStatus('Ch∆∞a k·∫øt n·ªëi Supabase', 'error');
        return;
      }

      const loading = document.getElementById('articlesLoading');
      const table = document.getElementById('articlesTable');
      const paginationContainer = document.getElementById('articlesPagination');

      // Check cache first
      const cacheKey = `page_${page}_size_${articlesPerPage}`;
      const now = Date.now();
      const cachedData = articlesCache.get(cacheKey);
      const cacheTime = articlesCacheTime.get(cacheKey) || 0;

      if (cachedData && (now - cacheTime) < ARTICLES_CACHE_DURATION) {
        renderArticlesFromCache(cachedData);
        return;
      }

      loading.style.display = 'block';
      table.innerHTML = '<div style="text-align: center; padding: 2rem; color: #718096;"><div class="loading-shimmer" style="width: 100%; height: 200px; border-radius: 8px;"></div></div>';
      paginationContainer.style.display = 'none';

      try {
        const from = (page - 1) * articlesPerPage;
        const to = from + articlesPerPage - 1;

        // Single optimized query with count and data
        const { data, error, count } = await supabase
          .from('articles')
          .select('id, title, category, status, is_published, created_at', { count: 'exact' })
          .order('created_at', { ascending: false })
          .range(from, to);

        if (error) throw error;

        // Update pagination vars
        totalArticles = count || 0;
        totalArticlesPages = Math.ceil(totalArticles / articlesPerPage);
        currentArticlesPage = page;

        if (totalArticles === 0) {
          loading.style.display = 'none';
          table.innerHTML = '<p style="text-align: center; padding: 2rem; color: #718096;">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>';
          return;
        }

        // Cache the results
        const cacheData = { data, count, totalArticles, totalArticlesPages, currentArticlesPage };
        articlesCache.set(cacheKey, cacheData);
        articlesCacheTime.set(cacheKey, now);

        // Render articles
        renderArticlesTable(data);

        loading.style.display = 'none';
        paginationContainer.style.display = 'flex';

        // Update pagination controls
        updateArticlesPagination();

        // Prefetch next page after a delay
        scheduleNextPagePrefetch();

      } catch (error) {
        loading.style.display = 'none';
        paginationContainer.style.display = 'none';
        console.error('Error loading articles:', error);
        showStatus('L·ªói t·∫£i danh s√°ch b√†i vi·∫øt: ' + error.message, 'error');
      }
    }

    // Prefetch next page for faster navigation
    function scheduleNextPagePrefetch() {
      if (prefetchTimeout) {
        clearTimeout(prefetchTimeout);
      }

      prefetchTimeout = setTimeout(() => {
        const nextPage = currentArticlesPage + 1;
        if (nextPage <= totalArticlesPages) {
          prefetchArticlesPage(nextPage);
        }
      }, 2000); // Prefetch after 2 seconds
    }

    async function prefetchArticlesPage(page) {
      const supabase = getSupabase();
      if (!supabase) return;

      const cacheKey = `page_${page}_size_${articlesPerPage}`;
      const now = Date.now();
      const cachedData = articlesCache.get(cacheKey);
      const cacheTime = articlesCacheTime.get(cacheKey) || 0;

      // Only prefetch if not already cached
      if (!cachedData || (now - cacheTime) >= ARTICLES_CACHE_DURATION) {
        try {
          const from = (page - 1) * articlesPerPage;
          const to = from + articlesPerPage - 1;

          const { data, error, count } = await supabase
            .from('articles')
            .select('id, title, category, status, is_published, created_at', { count: 'exact' })
            .order('created_at', { ascending: false })
            .range(from, to);

          if (!error && data) {
            const cacheData = {
              data,
              count,
              totalArticles: count,
              totalArticlesPages: Math.ceil(count / articlesPerPage),
              currentArticlesPage: page
            };
            articlesCache.set(cacheKey, cacheData);
            articlesCacheTime.set(cacheKey, now);
            console.log(`Prefetched page ${page}`);
          }
        } catch (error) {
          console.log(`Failed to prefetch page ${page}:`, error);
        }
      }
    }

    // Render articles table from data
    function renderArticlesTable(data) {
      const table = document.getElementById('articlesTable');

      if (!data || data.length === 0) {
        table.innerHTML = '<p style="text-align: center; padding: 2rem; color: #718096;">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>';
        return;
      }

      let tableHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Ti√™u ƒë·ªÅ</th>
              <th>Danh m·ª•c</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Ng√†y t·∫°o</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody>
      `;

      // Use DocumentFragment for better performance
      data.forEach(article => {
        const status = article.status || (article.is_published ? 'published' : 'draft');
        const statusClass = status === 'published' ? 'status-published' : 'status-draft';
        const statusText = status === 'published' ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nh√°p';
        const date = new Date(article.created_at).toLocaleDateString('vi-VN');

        tableHTML += `
          <tr>
            <td><strong>${escapeHtml(article.title)}</strong></td>
            <td>${escapeHtml(article.category)}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td>
              <button class="btn btn-secondary" onclick="editArticle('${article.id}')">
                ‚úèÔ∏è S·ª≠a
              </button>
              <button class="btn btn-danger" onclick="deleteArticle('${article.id}', '${escapeHtml(article.title)}')">
                üóëÔ∏è X√≥a
              </button>
            </td>
          </tr>
        `;
      });

      tableHTML += '</tbody></table>';
      table.innerHTML = tableHTML;
    }

    // Render from cache
    function renderArticlesFromCache(cachedData) {
      const loading = document.getElementById('articlesLoading');
      const paginationContainer = document.getElementById('articlesPagination');

      // Update vars from cache
      totalArticles = cachedData.totalArticles;
      totalArticlesPages = cachedData.totalArticlesPages;
      currentArticlesPage = cachedData.currentArticlesPage;

      // Render immediately from cache
      renderArticlesTable(cachedData.data);

      loading.style.display = 'none';
      paginationContainer.style.display = 'flex';
      updateArticlesPagination();
    }

    // Clear articles cache when needed
    function clearArticlesCache() {
      articlesCache.clear();
      articlesCacheTime.clear();
    }

    // HTML escape utility
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function refreshArticles() {
      // Clear cache on manual refresh
      clearArticlesCache();
      loadArticles(currentArticlesPage);
    }

    function editArticle(articleId) {
      // Redirect to compose page with article ID
      window.location.href = `admin-compose-e8d6c754705d3fce.html?edit=${articleId}`;
    }

    async function deleteArticle(articleId, title) {
      // Show "feature not ready" modal instead of allowing deletion
      await showFeatureNotReadyModal();
    }

    // Articles Pagination Functions
    function updateArticlesPagination() {
      const pageInfoElement = document.getElementById('articlesPageInfo');
      const pageNumbersElement = document.getElementById('articlesPageNumbers');
      const firstPageBtn = document.getElementById('articlesFirstPage');
      const prevPageBtn = document.getElementById('articlesPrevPage');
      const nextPageBtn = document.getElementById('articlesNextPage');
      const lastPageBtn = document.getElementById('articlesLastPage');
      const pageSizeSelect = document.getElementById('articlesPageSize');

      // Update page info
      const startItem = (currentArticlesPage - 1) * articlesPerPage + 1;
      const endItem = Math.min(currentArticlesPage * articlesPerPage, totalArticles);
      pageInfoElement.textContent = `Hi·ªÉn th·ªã ${startItem}-${endItem} c·ªßa ${totalArticles} b√†i vi·∫øt`;

      // Update page size selector
      pageSizeSelect.value = articlesPerPage;

      // Update button states
      firstPageBtn.disabled = currentArticlesPage === 1;
      prevPageBtn.disabled = currentArticlesPage === 1;
      nextPageBtn.disabled = currentArticlesPage === totalArticlesPages;
      lastPageBtn.disabled = currentArticlesPage === totalArticlesPages;

      // Generate page numbers
      generateArticlesPageNumbers();
    }

    function generateArticlesPageNumbers() {
      const pageNumbersElement = document.getElementById('articlesPageNumbers');

      // Skip if no pages
      if (totalArticlesPages <= 1) {
        pageNumbersElement.innerHTML = '';
        return;
      }

      // Use DocumentFragment for better performance
      const fragment = document.createDocumentFragment();
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentArticlesPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalArticlesPages, startPage + maxVisiblePages - 1);

      // Adjust start page if we're near the end
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // Add first page and ellipsis if needed
      if (startPage > 1) {
        const firstBtn = createPageButton(1, false);
        fragment.appendChild(firstBtn);

        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'page-number ellipsis';
          ellipsis.textContent = '...';
          fragment.appendChild(ellipsis);
        }
      }

      // Add visible page numbers
      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === currentArticlesPage;
        const pageBtn = createPageButton(i, isActive);
        fragment.appendChild(pageBtn);
      }

      // Add ellipsis and last page if needed
      if (endPage < totalArticlesPages) {
        if (endPage < totalArticlesPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'page-number ellipsis';
          ellipsis.textContent = '...';
          fragment.appendChild(ellipsis);
        }
        const lastBtn = createPageButton(totalArticlesPages, false);
        fragment.appendChild(lastBtn);
      }

      // Clear and append all at once
      pageNumbersElement.innerHTML = '';
      pageNumbersElement.appendChild(fragment);
    }

    // Helper function to create page buttons
    function createPageButton(pageNum, isActive) {
      const button = document.createElement('button');
      button.className = `page-number ${isActive ? 'active' : ''}`;
      button.textContent = pageNum;
      button.onclick = () => goToArticlesPage(pageNum);
      return button;
    }

    function goToArticlesPage(page) {
      if (page < 1 || page > totalArticlesPages || page === currentArticlesPage) {
        return;
      }
      loadArticles(page);
    }

    function changeArticlesPageSize(newSize) {
      articlesPerPage = parseInt(newSize);
      currentArticlesPage = 1; // Reset to first page

      // Clear cache when page size changes
      clearArticlesCache();
      loadArticles(1);
    }

    // Feature not ready modal
    function showFeatureNotReadyModal() {
      return new Promise((resolve) => {
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(4px);
        `;

        // Create modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 2rem;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease-out;
        `;

        modal.innerHTML = `
          <style>
            @keyframes modalSlideIn {
              from { transform: translateY(-50px); opacity: 0; }
              to { transform: translateY(0); opacity: 1; }
            }
          </style>
          <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üöß</div>
            <h3 style="color: #f39c12; margin-bottom: 1rem; font-size: 1.25rem;">T√≠nh nƒÉng ch∆∞a s·∫µn s√†ng</h3>
            <p style="color: #666; margin-bottom: 1.5rem; line-height: 1.6;">
              Ch·ª©c nƒÉng x√≥a b√†i vi·∫øt hi·ªán ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn v√† ch∆∞a s·∫µn s√†ng s·ª≠ d·ª•ng.
            </p>
            <div style="background: #e3f2fd; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
              <div style="color: #1976d2; font-size: 0.9rem; line-height: 1.4;">
                üí° <strong>G·ª£i √Ω:</strong> Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n n·∫øu c·∫ßn x√≥a b√†i vi·∫øt c·ª• th·ªÉ.
              </div>
            </div>
            <button id="closeModal" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 0.75rem 2rem;
              border-radius: 6px;
              font-weight: 600;
              cursor: pointer;
              transition: background-color 0.2s;
              margin-top: 1rem;
            " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
              ƒê√£ hi·ªÉu
            </button>
          </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Add event listeners
        const closeBtn = modal.querySelector('#closeModal');

        closeBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve();
        });

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            document.body.removeChild(overlay);
            resolve();
          }
        });

        // Close on Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
            resolve();
          }
        };
        document.addEventListener('keydown', handleEscape);
      });
    }

    // Users management
    async function loadUsers() {
      const supabase = getSupabase();
      if (!supabase) {
        showStatus('Ch∆∞a k·∫øt n·ªëi Supabase', 'error');
        return;
      }

      const loading = document.getElementById('usersLoading');
      const table = document.getElementById('usersTable');

      loading.style.display = 'block';
      table.innerHTML = '';

      try {
        const { data, error } = await supabase
          .from('registrations')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        loading.style.display = 'none';

        if (data.length === 0) {
          table.innerHTML = '<p style="text-align: center; padding: 2rem; color: #718096;">Ch∆∞a c√≥ ng∆∞·ªùi ƒëƒÉng k√Ω n√†o</p>';
          return;
        }

        let tableHTML = `
          <table class="data-table">
            <thead>
              <tr>
                <th>H·ªç t√™n</th>
                <th>Email</th>
                <th>S·ªë ƒëi·ªán tho·∫°i</th>
                <th>D·ªãch v·ª• quan t√¢m</th>
                <th>Ng√†y ƒëƒÉng k√Ω</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach(user => {
          const date = new Date(user.created_at).toLocaleDateString('vi-VN');
          const status = user.status || 'pending';
          const statusClass = status === 'contacted' ? 'status-active' : 'status-pending';
          const statusText = status === 'contacted' ? 'ƒê√£ li√™n h·ªá' : 'Ch∆∞a li√™n h·ªá';

          tableHTML += `
            <tr>
              <td><strong>${user.full_name || user.name || 'N/A'}</strong></td>
              <td>${user.email || 'N/A'}</td>
              <td>${user.phone || 'N/A'}</td>
              <td>${user.service_interest || user.message || 'N/A'}</td>
              <td>${date}</td>
              <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td>
                <button class="btn btn-success" onclick="markAsContacted('${user.id}')">
                  ‚úÖ ƒê√£ li√™n h·ªá
                </button>
                <button class="btn btn-danger" onclick="deleteUser('${user.id}', '${user.full_name || user.name}')">
                  üóëÔ∏è X√≥a
                </button>
              </td>
            </tr>
          `;
        });

        tableHTML += '</tbody></table>';
        table.innerHTML = tableHTML;

      } catch (error) {
        loading.style.display = 'none';
        console.error('Error loading users:', error);
        showStatus('L·ªói t·∫£i danh s√°ch ng∆∞·ªùi ƒëƒÉng k√Ω: ' + error.message, 'error');
      }
    }

    function refreshUsers() {
      loadUsers();
    }

    async function markAsContacted(userId) {
      try {
        const { error } = await supabase
          .from('registrations')
          .update({ status: 'contacted' })
          .eq('id', userId);

        if (error) throw error;

        showStatus('ƒê√£ ƒë√°nh d·∫•u l√† ƒë√£ li√™n h·ªá!', 'success');
        loadUsers();
      } catch (error) {
        console.error('Error updating user status:', error);
        showStatus('L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + error.message, 'error');
      }
    }

    // Custom delete confirmation modal
    function showDeleteConfirmationModal(title, message, warning, confirmText, cancelText) {
      return new Promise((resolve) => {
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(4px);
        `;

        // Create modal content
        const modal = document.createElement('div');
        modal.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 2rem;
          max-width: 500px;
          width: 90%;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
          animation: modalSlideIn 0.3s ease-out;
        `;

        modal.innerHTML = `
          <style>
            @keyframes modalSlideIn {
              from { transform: translateY(-50px); opacity: 0; }
              to { transform: translateY(0); opacity: 1; }
            }
          </style>
          <div style="text-align: center;">
            <h3 style="color: #dc3545; margin-bottom: 1rem; font-size: 1.25rem;">${title}</h3>
            <p style="color: #333; margin-bottom: 1rem; line-height: 1.6;">${message}</p>
            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
              <div style="color: #856404; font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è C·∫¢NH B√ÅO:</div>
              <div style="color: #856404; font-size: 0.9rem; line-height: 1.4;">${warning}</div>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
              <button id="confirmDelete" style="
                background: #dc3545;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                ${confirmText}
              </button>
              <button id="cancelDelete" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 6px;
                font-weight: 600;
                cursor: pointer;
                transition: background-color 0.2s;
              " onmouseover="this.style.background='#545b62'" onmouseout="this.style.background='#6c757d'">
                ${cancelText}
              </button>
            </div>
          </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Add event listeners
        const confirmBtn = modal.querySelector('#confirmDelete');
        const cancelBtn = modal.querySelector('#cancelDelete');

        confirmBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(true);
        });

        cancelBtn.addEventListener('click', () => {
          document.body.removeChild(overlay);
          resolve(false);
        });

        // Close on overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            document.body.removeChild(overlay);
            resolve(false);
          }
        });

        // Close on Escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(overlay);
            document.removeEventListener('keydown', handleEscape);
            resolve(false);
          }
        };
        document.addEventListener('keydown', handleEscape);
      });
    }

    async function deleteUser(userId, name) {
      // Create and show custom confirmation modal
      const confirmed = await showDeleteConfirmationModal(
        'üóëÔ∏è X√°c nh·∫≠n x√≥a ng∆∞·ªùi ƒëƒÉng k√Ω',
        `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëƒÉng k√Ω c·ªßa "${name}"?`,
        'H√†nh ƒë·ªông n√†y s·∫Ω X√ìA Vƒ®NH VI·ªÑN th√¥ng tin ƒëƒÉng k√Ω v√† KH√îNG TH·ªÇ HO√ÄN T√ÅC hay kh√¥i ph·ª•c l·∫°i.',
        'X√≥a vƒ©nh vi·ªÖn',
        'H·ªßy b·ªè'
      );

      if (!confirmed) {
        return;
      }

      try {
        const { error } = await supabase
          .from('registrations')
          .delete()
          .eq('id', userId);

        if (error) throw error;

        showStatus('ƒê√£ x√≥a ƒëƒÉng k√Ω th√†nh c√¥ng!', 'success');
        loadUsers();
        loadOverviewStats();
      } catch (error) {
        console.error('Error deleting user:', error);
        showStatus('L·ªói x√≥a ƒëƒÉng k√Ω: ' + error.message, 'error');
      }
    }

    // Utility functions
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';

      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 5000);
    }

    // Legacy logout function - now handled by AdminAuthManager
    function logout() {
      if (adminAuth) {
        adminAuth.logout();
      } else {
        console.warn('‚ö†Ô∏è AdminAuth not available - clearing session');
        sessionStorage.clear();
        location.reload();
      }
    }

    // Help Modal Functions
    function showHelpModal() {
      const modal = document.getElementById('helpModal');
      modal.style.display = 'flex';

      // Add keyboard event listener
      document.addEventListener('keydown', handleHelpModalKeyboard);
    }

    function hideHelpModal() {
      const modal = document.getElementById('helpModal');
      modal.style.display = 'none';

      // Remove keyboard event listener
      document.removeEventListener('keydown', handleHelpModalKeyboard);
    }

    function handleHelpModalBackdrop(event) {
      if (event.target === event.currentTarget) {
        hideHelpModal();
      }
    }

    function handleHelpModalKeyboard(event) {
      if (event.key === 'Escape') {
        hideHelpModal();
      }
    }

    function showHelpSection(sectionId) {
      // Hide all sections
      const sections = document.querySelectorAll('.help-section');
      sections.forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from nav items
      const navItems = document.querySelectorAll('.help-nav-item');
      navItems.forEach(item => {
        item.classList.remove('active');
      });

      // Show selected section
      const targetSection = document.getElementById('help-' + sectionId);
      if (targetSection) {
        targetSection.classList.add('active');
      }

      // Add active class to clicked nav item
      const clickedNavItem = event.target;
      if (clickedNavItem) {
        clickedNavItem.classList.add('active');
      }
    }

    // Mobile Sidebar Functions
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');

      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }

    function closeMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');

      sidebar.classList.remove('mobile-open');
      overlay.classList.remove('show');
    }

    // Close mobile sidebar when clicking nav items
    document.addEventListener('DOMContentLoaded', function () {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', function () {
          // Close mobile sidebar after small delay
          setTimeout(closeMobileSidebar, 150);
        });
      });

      // Handle window resize
      window.addEventListener('resize', function () {
        if (window.innerWidth > 768) {
          closeMobileSidebar();
        }
      });
    });

    // Chart Functions
    async function loadChart(period = 15, forceRefresh = false) {
      const supabase = getSupabase();
      if (!supabase) return;

      // Check cache first
      const cacheKey = `chart_${period}`;
      const now = Date.now();
      if (!forceRefresh && chartDataCache.has(cacheKey)) {
        const cached = chartDataCache.get(cacheKey);
        if (now - cached.timestamp < CACHE_DURATION) {
          renderChart(cached.data, period);
          return;
        }
      }

      // Show loading with better message
      const loadingEl = document.getElementById('chartLoading');
      loadingEl.innerHTML = `
        <div class="loading-spinner"></div>
        <div>ƒêang t·∫£i d·ªØ li·ªáu ${period} ng√†y...</div>
      `;
      loadingEl.style.display = 'flex';

      try {
        // Calculate date range - from current date back to period days ago
        const endDate = new Date();
        const startDate = new Date();

        // Use more accurate date calculation for longer periods
        if (period >= 365) {
          // For 1 year, go back exactly 1 year
          startDate.setFullYear(endDate.getFullYear() - 1);
        } else if (period >= 90) {
          // For 3 months, go back 3 months
          startDate.setMonth(endDate.getMonth() - 3);
        } else if (period >= 30) {
          // For 1 month, go back 1 month
          startDate.setMonth(endDate.getMonth() - 1);
        } else {
          // For shorter periods, use days
          startDate.setDate(endDate.getDate() - period);
        }

        // Debug log to check date range
        console.log(`Chart period: ${period} days`);
        console.log(`Start date: ${startDate.toLocaleDateString('vi-VN')} (${startDate.toISOString().split('T')[0]})`);
        console.log(`End date: ${endDate.toLocaleDateString('vi-VN')} (${endDate.toISOString().split('T')[0]})`);

        // Single query to get all articles in the period - much faster!
        const { data: articles, error } = await supabase
          .from('articles')
          .select('created_at')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
          .order('created_at', { ascending: true });

        if (error) throw error;

        // Determine optimal step size and format for readability
        let stepDays = 1;
        let labelFormat = { month: 'short', day: 'numeric' };
        let maxDataPoints = 20; // Optimal number of points for chart readability

        if (period >= 365) { // 1 year - show monthly data
          stepDays = 30; // Monthly intervals
          labelFormat = { month: 'short', year: '2-digit' };
          maxDataPoints = 12; // 12 months
        } else if (period >= 180) { // 6 months - show bi-weekly
          stepDays = 14; // Bi-weekly intervals  
          labelFormat = { month: 'short', day: 'numeric' };
          maxDataPoints = 13; // ~13 points
        } else if (period >= 90) { // 3 months - show weekly
          stepDays = 7; // Weekly intervals
          labelFormat = { month: 'short', day: 'numeric' };
          maxDataPoints = 13; // ~13 weeks
        } else if (period >= 30) { // 1 month - show every 2-3 days
          stepDays = 2; // Every 2 days
          labelFormat = { month: 'short', day: 'numeric' };
          maxDataPoints = 15; // ~15 points
        } else { // 15 days - daily
          stepDays = 1; // Daily
          labelFormat = { month: 'short', day: 'numeric' };
          maxDataPoints = 15; // 15 days
        }

        console.log(`Using step: ${stepDays} days, targeting ~${maxDataPoints} data points`);

        // Process data on client side - group by date intervals
        const dateCountMap = new Map();
        const labels = [];
        const dateRanges = [];

        // Normalize start and end dates to avoid timezone issues
        const normalizedStartDate = new Date(startDate);
        normalizedStartDate.setHours(0, 0, 0, 0);
        const normalizedEndDate = new Date(endDate);
        normalizedEndDate.setHours(23, 59, 59, 999);

        // Initialize date ranges with step intervals
        const currentDate = new Date(normalizedStartDate);
        while (currentDate <= normalizedEndDate) {
          const rangeStart = new Date(currentDate);
          rangeStart.setHours(0, 0, 0, 0);

          const rangeEnd = new Date(currentDate);
          rangeEnd.setDate(rangeEnd.getDate() + stepDays - 1);
          rangeEnd.setHours(23, 59, 59, 999);

          // Don't exceed end date
          if (rangeEnd > normalizedEndDate) {
            rangeEnd.setTime(normalizedEndDate.getTime());
          }

          const rangeKey = `${rangeStart.toISOString().split('T')[0]}_${rangeEnd.toISOString().split('T')[0]}`;
          dateCountMap.set(rangeKey, 0);
          dateRanges.push({
            start: new Date(rangeStart),
            end: new Date(rangeEnd),
            key: rangeKey,
            startDateStr: rangeStart.toISOString().split('T')[0],
            endDateStr: rangeEnd.toISOString().split('T')[0]
          });

          // Create smart labels based on step size
          let label;
          if (stepDays === 1) {
            // Daily: "8/11"
            label = rangeStart.toLocaleDateString('vi-VN', labelFormat);
          } else if (stepDays === 30) {
            // Monthly: "T11/25" or "Th11"
            label = rangeStart.toLocaleDateString('vi-VN', { month: 'short', year: '2-digit' });
          } else if (stepDays === 14) {
            // Bi-weekly: "8/11"
            label = rangeStart.toLocaleDateString('vi-VN', labelFormat);
          } else if (stepDays === 7) {
            // Weekly: "8/11"
            label = rangeStart.toLocaleDateString('vi-VN', labelFormat);
          } else if (stepDays === 2) {
            // Every 2 days: "8/11"
            label = rangeStart.toLocaleDateString('vi-VN', labelFormat);
          } else {
            // Multi-day: "8/11"
            label = rangeStart.toLocaleDateString('vi-VN', labelFormat);
          }
          labels.push(label);

          currentDate.setDate(currentDate.getDate() + stepDays);
        }

        // Count articles by date range - using date strings for accurate comparison
        if (articles && articles.length > 0) {
          articles.forEach(article => {
            // Convert article date to date string for comparison
            const articleDateStr = new Date(article.created_at).toISOString().split('T')[0];

            // Find which range this article belongs to
            for (const range of dateRanges) {
              if (articleDateStr >= range.startDateStr && articleDateStr <= range.endDateStr) {
                dateCountMap.set(range.key, dateCountMap.get(range.key) + 1);
                break;
              }
            }
          });
        }

        // Convert to array for chart
        const data = Array.from(dateCountMap.values());
        const chartData = { labels, data };

        // Cache the data
        chartDataCache.set(cacheKey, {
          data: chartData,
          timestamp: now
        });

        renderChart(chartData, period);

      } catch (error) {
        console.error('Error loading chart data:', error);
        document.getElementById('chartLoading').innerHTML = `
          <div style="color: #e53e3e; font-size: 0.875rem;">
            ‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì
          </div>
        `;
      } finally {
        setTimeout(() => {
          document.getElementById('chartLoading').style.display = 'none';
        }, 500);
      }
    }

    function renderChart(chartData, period) {
      const ctx = document.getElementById('articlesChart').getContext('2d');

      // Destroy existing chart
      if (articlesChart) {
        articlesChart.destroy();
      }

      // Determine label based on period - match the step logic
      let datasetLabel = 'S·ªë b√†i vi·∫øt m·ªõi';

      if (period >= 365) {
        datasetLabel = 'B√†i vi·∫øt/th√°ng';
      } else if (period >= 180) {
        datasetLabel = 'B√†i vi·∫øt/2 tu·∫ßn';
      } else if (period >= 90) {
        datasetLabel = 'B√†i vi·∫øt/tu·∫ßn';
      } else if (period >= 30) {
        datasetLabel = 'B√†i vi·∫øt/2 ng√†y';
      }

      // Create new chart
      articlesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: datasetLabel,
            data: chartData.data,
            borderColor: '#0060ae',
            backgroundColor: 'rgba(0, 96, 174, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#0060ae',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#0060ae',
              borderWidth: 1,
              cornerRadius: 6,
              displayColors: false,
              callbacks: {
                title: function (context) {
                  const label = context[0].label;

                  // Use same step logic as above
                  let stepDays = 1;
                  let periodName = 'ng√†y';

                  if (period >= 365) {
                    stepDays = 30;
                    periodName = 'th√°ng';
                  } else if (period >= 180) {
                    stepDays = 14;
                    periodName = '2 tu·∫ßn';
                  } else if (period >= 90) {
                    stepDays = 7;
                    periodName = 'tu·∫ßn';
                  } else if (period >= 30) {
                    stepDays = 2;
                    periodName = '2 ng√†y';
                  }

                  if (stepDays === 1) {
                    return label;
                  } else {
                    return `${label} (${periodName})`;
                  }
                },
                label: function (context) {
                  // Use same step logic as above
                  let stepDays = 1;
                  let periodName = 'ng√†y';

                  if (period >= 365) {
                    stepDays = 30;
                    periodName = 'th√°ng';
                  } else if (period >= 180) {
                    stepDays = 14;
                    periodName = '2 tu·∫ßn';
                  } else if (period >= 90) {
                    stepDays = 7;
                    periodName = 'tu·∫ßn';
                  } else if (period >= 30) {
                    stepDays = 2;
                    periodName = '2 ng√†y';
                  }

                  const count = context.parsed.y;
                  if (stepDays === 1) {
                    return `${count} b√†i vi·∫øt`;
                  } else {
                    return `${count} b√†i vi·∫øt/${periodName}`;
                  }
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#718096',
                font: {
                  size: 11
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                color: '#718096',
                font: {
                  size: 11
                },
                stepSize: 1
              }
            }
          }
        }
      });
    }

    function changeChartPeriod(period) {
      // Update active button immediately for instant feedback
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.chart-btn[data-period="${period}"]`).classList.add('active');

      // Show loading immediately if data not cached
      const cacheKey = `chart_${period}`;
      const now = Date.now();
      const isCached = chartDataCache.has(cacheKey) &&
        (now - chartDataCache.get(cacheKey).timestamp) < CACHE_DURATION;

      if (!isCached) {
        document.getElementById('chartLoading').style.display = 'flex';
      }

      // Update current period and load chart
      currentChartPeriod = period;
      loadChart(period);
    }

    // Registration Chart Functions
    async function loadRegistrationChart(period = 30, forceRefresh = false) {
      const supabase = getSupabase();
      if (!supabase) return;

      // Check cache first
      const cacheKey = `registration_chart_${period}`;
      const now = Date.now();
      if (!forceRefresh && registrationChartDataCache.has(cacheKey)) {
        const cached = registrationChartDataCache.get(cacheKey);
        if (now - cached.timestamp < CACHE_DURATION) {
          renderRegistrationChart(cached.data, period);
          return;
        }
      }

      // Show loading with better message
      const loadingEl = document.getElementById('registrationChartLoading');
      loadingEl.innerHTML = `
        <div class="loading-spinner"></div>
        <div>ƒêang t·∫£i th·ªëng k√™ ${period} ng√†y...</div>
      `;
      loadingEl.style.display = 'flex';

      try {
        // Calculate date range
        const endDate = new Date();
        const startDate = new Date();

        // Use more accurate date calculation
        if (period >= 365) {
          startDate.setFullYear(endDate.getFullYear() - 1);
        } else if (period >= 180) {
          startDate.setMonth(endDate.getMonth() - 6);
        } else if (period >= 90) {
          startDate.setMonth(endDate.getMonth() - 3);
        } else if (period >= 30) {
          startDate.setMonth(endDate.getMonth() - 1);
        } else {
          startDate.setDate(endDate.getDate() - period);
        }

        console.log(`Registration chart period: ${period} days`);
        console.log(`Start date: ${startDate.toLocaleDateString('vi-VN')}`);
        console.log(`End date: ${endDate.toLocaleDateString('vi-VN')}`);

        // Query user registrations with service interest information
        const { data: registrations, error } = await supabase
          .from('registrations')
          .select('created_at, service_interest')
          .gte('created_at', startDate.toISOString())
          .lte('created_at', endDate.toISOString())
          .order('created_at', { ascending: true });

        if (error) throw error;

        // Determine step size based on period
        let stepDays = 7; // Default weekly for registration stats

        if (period >= 365) {
          stepDays = 30; // Monthly
        } else if (period >= 180) {
          stepDays = 14; // Bi-weekly
        } else if (period >= 90) {
          stepDays = 7; // Weekly
        } else {
          stepDays = 7; // Weekly even for 1 month
        }

        // Extract unique service interests from actual data
        const servicesSet = new Set();
        if (registrations && registrations.length > 0) {
          registrations.forEach(registration => {
            if (registration.service_interest && registration.service_interest.trim() !== '') {
              servicesSet.add(registration.service_interest.trim());
            }
          });
        }

        const services = Array.from(servicesSet).sort();

        // Service interests are already readable strings, use them directly
        const serviceNames = {};
        services.forEach(service => {
          serviceNames[service] = service; // Use the string value as-is
        });

        console.log('Found service interests:', services);
        console.log('Service names:', serviceNames);

        // Initialize date ranges
        const dateRanges = [];
        const labels = [];
        const normalizedStartDate = new Date(startDate);
        normalizedStartDate.setHours(0, 0, 0, 0);
        const normalizedEndDate = new Date(endDate);
        normalizedEndDate.setHours(23, 59, 59, 999);

        const currentDate = new Date(normalizedStartDate);
        while (currentDate <= normalizedEndDate) {
          const rangeStart = new Date(currentDate);
          rangeStart.setHours(0, 0, 0, 0);

          const rangeEnd = new Date(currentDate);
          rangeEnd.setDate(rangeEnd.getDate() + stepDays - 1);
          rangeEnd.setHours(23, 59, 59, 999);

          if (rangeEnd > normalizedEndDate) {
            rangeEnd.setTime(normalizedEndDate.getTime());
          }

          dateRanges.push({
            start: new Date(rangeStart),
            end: new Date(rangeEnd),
            startDateStr: rangeStart.toISOString().split('T')[0],
            endDateStr: rangeEnd.toISOString().split('T')[0]
          });

          // Create labels
          if (stepDays === 30) {
            labels.push(rangeStart.toLocaleDateString('vi-VN', { month: 'short', year: '2-digit' }));
          } else {
            labels.push(rangeStart.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' }));
          }

          currentDate.setDate(currentDate.getDate() + stepDays);
        }

        // Count registrations by service and time period
        const datasets = [];

        // Generate colors dynamically for any number of services
        const generateColors = (count) => {
          const baseColors = [
            '#0060ae', '#38a169', '#e53e3e', '#dd6b20', '#805ad5',
            '#3182ce', '#319795', '#d69e2e', '#9f7aea', '#ed64a6',
            '#4299e1', '#48bb78', '#ed8936', '#667eea', '#f56565'
          ];

          if (count <= baseColors.length) {
            return baseColors.slice(0, count);
          }

          // Generate additional colors if needed
          const colors = [...baseColors];
          for (let i = baseColors.length; i < count; i++) {
            const hue = (i * 137.508) % 360; // Golden angle approximation
            colors.push(`hsl(${hue}, 70%, 50%)`);
          }
          return colors;
        };

        const colors = generateColors(services.length);

        services.forEach((service, index) => {
          const serviceCounts = new Array(dateRanges.length).fill(0);

          if (registrations && registrations.length > 0) {
            registrations.forEach(registration => {
              const registrationServiceInterest = registration.service_interest ? registration.service_interest.trim() : '';
              if (registrationServiceInterest === service) {
                const registrationDateStr = new Date(registration.created_at).toISOString().split('T')[0];

                // Find which range this registration belongs to
                for (let i = 0; i < dateRanges.length; i++) {
                  const range = dateRanges[i];
                  if (registrationDateStr >= range.startDateStr && registrationDateStr <= range.endDateStr) {
                    serviceCounts[i]++;
                    break;
                  }
                }
              }
            });
          }

          datasets.push({
            label: serviceNames[service],
            data: serviceCounts,
            backgroundColor: colors[index],
            borderColor: colors[index],
            borderWidth: 2,
            fill: false,
            tension: 0.4
          });
        });

        const chartData = { labels, datasets };

        // Cache the data
        registrationChartDataCache.set(cacheKey, {
          data: chartData,
          timestamp: now
        });

        renderRegistrationChart(chartData, period);

      } catch (error) {
        console.error('Error loading registration chart data:', error);
        document.getElementById('registrationChartLoading').innerHTML = `
          <div style="color: #e53e3e; font-size: 0.875rem;">
            ‚ùå Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ ƒëƒÉng k√Ω
          </div>
        `;
      } finally {
        setTimeout(() => {
          document.getElementById('registrationChartLoading').style.display = 'none';
        }, 500);
      }
    }

    function renderRegistrationChart(chartData, period) {
      const ctx = document.getElementById('registrationChart').getContext('2d');

      // Destroy existing chart
      if (registrationChart) {
        registrationChart.destroy();
      }

      // Create new chart
      registrationChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: {
                  size: 11
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#0060ae',
              borderWidth: 1,
              cornerRadius: 6,
              callbacks: {
                title: function (context) {
                  return context[0].label;
                },
                label: function (context) {
                  return `${context.dataset.label}: ${context.parsed.y} ng∆∞·ªùi`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: '#718096',
                font: {
                  size: 10
                }
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                color: '#718096',
                font: {
                  size: 10
                },
                stepSize: 1
              }
            }
          }
        }
      });
    }

    function changeRegistrationChartPeriod(period) {
      // Update active button immediately
      document.querySelectorAll('.registration-chart-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.registration-chart-btn[data-period="${period}"]`).classList.add('active');

      // Show loading immediately if data not cached
      const cacheKey = `registration_chart_${period}`;
      const now = Date.now();
      const isCached = registrationChartDataCache.has(cacheKey) &&
        (now - registrationChartDataCache.get(cacheKey).timestamp) < CACHE_DURATION;

      if (!isCached) {
        document.getElementById('registrationChartLoading').style.display = 'flex';
      }

      // Update current period and load chart
      currentRegistrationChartPeriod = period;
      loadRegistrationChart(period);
    }
    // =====================================================
    // User Analytics Functions
    // =====================================================

    // Analytics charts instances
    let pageViewsChart = null;
    let trafficSourcesChart = null;
    let analyticsInitialized = false;
    let analyticsRefreshTimers = [];

    function clearAnalyticsRefreshTimers() {
      analyticsRefreshTimers.forEach(timerId => clearInterval(timerId));
      analyticsRefreshTimers = [];
    }

    function resetAnalyticsState() {
      clearAnalyticsRefreshTimers();
      analyticsInitialized = false;

      const resetValues = {
        totalViews: '-',
        uniqueVisitors: '-',
        avgTimeOnSite: '-',
        bounceRate: '-',
        liveVisitors: '-',
      };

      Object.entries(resetValues).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });

      const livePagesContainer = document.getElementById('livePages');
      if (livePagesContainer) {
        livePagesContainer.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
      }

      const topPagesContainer = document.getElementById('topPagesTable');
      if (topPagesContainer) {
        topPagesContainer.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
      }

      const trafficSourcesList = document.getElementById('trafficSourcesList');
      if (trafficSourcesList) {
        trafficSourcesList.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
      }

      const keywordsCloud = document.getElementById('keywordsCloud');
      if (keywordsCloud) {
        keywordsCloud.innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
      }

      if (pageViewsChart) {
        pageViewsChart.destroy();
        pageViewsChart = null;
      }

      if (trafficSourcesChart) {
        trafficSourcesChart.destroy();
        trafficSourcesChart = null;
      }
    }

    function ensureAdminSessionForAnalytics() {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        throw new Error('Y√™u c·∫ßu ƒëƒÉng nh·∫≠p Admin ƒë·ªÉ t·∫£i analytics');
      }
    }

    async function fetchSupabaseFunction(path, options = {}) {
      ensureAdminSessionForAnalytics();

      const baseUrl = window.SUPABASE_CONFIG?.url;
      if (!baseUrl) {
        throw new Error('Supabase config ch∆∞a s·∫µn s√†ng');
      }

      const authHeaders = { ...adminAuth.getAuthHeaders() };

      // Lo·∫°i b·ªè Content-Type m·∫∑c ƒë·ªãnh cho c√°c request GET
      const method = (options.method || 'GET').toUpperCase();
      if (method === 'GET' && !options.body && authHeaders['Content-Type']) {
        delete authHeaders['Content-Type'];
      }

      const response = await fetch(`${baseUrl.replace(/\/$/, '')}/functions/v1/${path}`, {
        ...options,
        headers: {
          ...authHeaders,
          ...options.headers,
        },
      });

      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`HTTP ${response.status} ${response.statusText} ${errorText}`.trim());
      }

      return response;
    }

    // Initialize analytics dashboard
    async function initAnalytics() {
      try {
        ensureAdminSessionForAnalytics();

        clearAnalyticsRefreshTimers();
        if (!analyticsInitialized) {
          resetAnalyticsState();
        }

        await Promise.all([
          loadAnalyticsSummary(),
          loadRealtimeStats(),
          loadTopPages(),
          loadTrafficSources(),
          loadKeywords(),
          loadPageViewsChart()
        ]);

        analyticsRefreshTimers.push(
          setInterval(() => {
            loadRealtimeStats().catch(error => console.error('Realtime stats refresh failed:', error));
          }, 30000),
          setInterval(() => {
            loadAnalyticsSummary().catch(error => console.error('Analytics summary refresh failed:', error));
          }, 60000)
        );

        analyticsInitialized = true;
        initializeAdminAnalytics();
        console.log('üìä Analytics dashboard initialized');
      } catch (error) {
        console.error('Analytics initialization error:', error);
        setAnalyticsError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu analytics');
      }
    }

    // Load analytics summary stats
    async function loadAnalyticsSummary(days = 30) {
      try {
        const response = await fetchSupabaseFunction(`track-user-behavior?type=summary&days=${days}`);
        const data = await response.json();

        // Update summary stats - check if elements exist before setting
        const totalViewsEl = document.getElementById('totalViews');
        if (totalViewsEl) {
          totalViewsEl.textContent = data.summary.reduce((sum, day) => sum + (day.total_views || 0), 0).toLocaleString();
        }

        const uniqueVisitorsEl = document.getElementById('uniqueVisitors');
        if (uniqueVisitorsEl) {
          uniqueVisitorsEl.textContent = data.summary.reduce((sum, day) => sum + (day.unique_visitors || 0), 0).toLocaleString();
        }

        const avgTimeOnSiteEl = document.getElementById('avgTimeOnSite');
        if (avgTimeOnSiteEl && data.summary.length > 0) {
          const avgTime = data.summary.reduce((sum, day) => sum + (day.avg_session_duration || 0), 0) / data.summary.length;
          avgTimeOnSiteEl.textContent = formatDuration(avgTime);
        }

        const bounceRateEl = document.getElementById('bounceRate');
        if (bounceRateEl && data.summary.length > 0) {
          const avgBounce = data.summary.reduce((sum, day) => sum + (day.bounce_rate || 0), 0) / data.summary.length;
          bounceRateEl.textContent = avgBounce.toFixed(1) + '%';
        }

        // Update realtime stats
        const liveVisitorsEl = document.getElementById('liveVisitors');
        if (liveVisitorsEl) {
          liveVisitorsEl.textContent = data.active_users || 0;
        }

      } catch (error) {
        console.error('Error loading analytics summary:', error);
        setAnalyticsError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ªïng quan');
      }
    }

    // Load realtime statistics
    async function loadRealtimeStats() {
      try {
        const response = await fetchSupabaseFunction('track-user-behavior?type=summary&days=1');
        if (response.ok) {
          const data = await response.json();

          // Update live visitor count - check if element exists
          const liveVisitorsEl = document.getElementById('liveVisitors');
          if (liveVisitorsEl) {
            liveVisitorsEl.textContent = data.active_users || 0;
          }

          // Update live pages (mock data for now) - check if element exists
          const livePagesContainer = document.getElementById('livePages');
          if (livePagesContainer) {
            // Sanitize HTML to prevent XSS
            const page1Count = Math.floor(Math.random() * 5) + 1;
            const page2Count = Math.floor(Math.random() * 3) + 1;
            const page3Count = Math.floor(Math.random() * 4) + 1;

            livePagesContainer.innerHTML = `
            <div class="live-page-item">
              <span class="live-page-title">B·∫£o hi·ªÉm √¥ t√¥</span>
              <span class="live-page-count">${page1Count}</span>
            </div>
            <div class="live-page-item">
              <span class="live-page-title">B·∫£o hi·ªÉm s·ª©c kh·ªèe</span>
              <span class="live-page-count">${page2Count}</span>
            </div>
            <div class="live-page-item">
              <span class="live-page-title">Trang ch·ªß</span>
              <span class="live-page-count">${page3Count}</span>
            </div>
          `;
          }
        }
      } catch (error) {
        console.error('Error loading realtime stats:', error);
      }
    }

    // Load top pages
    async function loadTopPages(days = 30) {
      try {
        const response = await fetchSupabaseFunction(`track-user-behavior?type=pages&days=${days}`);
        const data = await response.json();
        const topPagesContainer = document.getElementById('topPagesTable');

        if (data.pages && data.pages.length > 0) {
          topPagesContainer.innerHTML = data.pages.slice(0, 10).map(page => `
            <div class="table-row">
              <span class="table-cell-title">${page.page_title || page.page_path}</span>
              <span class="table-cell-value">${page.total_views.toLocaleString()}</span>
            </div>
          `).join('');
        } else {
          topPagesContainer.innerHTML = '<div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        }

      } catch (error) {
        console.error('Error loading top pages:', error);
        document.getElementById('topPagesTable').innerHTML =
          '<div class="loading">L·ªói t·∫£i d·ªØ li·ªáu</div>';
      }
    }

    // Load traffic sources
    async function loadTrafficSources(days = 30) {
      try {
        const response = await fetchSupabaseFunction(`track-user-behavior?type=traffic_sources&days=${days}`);
        const data = await response.json();
        const trafficContainer = document.getElementById('trafficSourcesList');

        if (data.traffic_sources && data.traffic_sources.length > 0) {
          const total = data.traffic_sources.reduce((sum, source) => sum + source.visits, 0);

          trafficContainer.innerHTML = data.traffic_sources.map(source => {
            const percentage = ((source.visits / total) * 100).toFixed(1);
            const iconClass = getTrafficSourceIcon(source.source);

            return `
              <div class="traffic-source-item">
                <div class="traffic-source-name">
                  <div class="traffic-source-icon ${iconClass}">
                    ${getTrafficSourceEmoji(source.source)}
                  </div>
                  ${source.source} (${source.medium})
                </div>
                <div class="traffic-source-stats">
                  <div class="traffic-source-visits">${source.visits.toLocaleString()}</div>
                  <div class="traffic-source-percentage">${percentage}%</div>
                </div>
              </div>
            `;
          }).join('');

          // Update pie chart
          updateTrafficSourcesChart(data.traffic_sources);
        } else {
          trafficContainer.innerHTML = '<div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        }

      } catch (error) {
        console.error('Error loading traffic sources:', error);
        document.getElementById('trafficSourcesList').innerHTML =
          '<div class="loading">L·ªói t·∫£i d·ªØ li·ªáu</div>';
      }
    }

    // Load keywords
    async function loadKeywords(days = 30) {
      try {
        const response = await fetchSupabaseFunction(`track-user-behavior?type=keywords&days=${days}`);
        const data = await response.json();
        const keywordsContainer = document.getElementById('keywordsCloud');

        if (data.keywords && data.keywords.length > 0) {
          keywordsContainer.innerHTML = data.keywords.slice(0, 20).map(keyword => `
            <div class="keyword-tag">
              ${keyword.keyword}
              <span class="keyword-frequency">${keyword.frequency}</span>
            </div>
          `).join('');
        } else {
          keywordsContainer.innerHTML = '<div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu</div>';
        }

      } catch (error) {
        console.error('Error loading keywords:', error);
        document.getElementById('keywordsCloud').innerHTML =
          '<div class="loading">L·ªói t·∫£i d·ªØ li·ªáu</div>';
      }
    }

    // Load page views chart
    async function loadPageViewsChart(days = 7) {
      try {
        const response = await fetchSupabaseFunction(`track-user-behavior?type=summary&days=${days}`);
        const data = await response.json();

        if (data.summary && data.summary.length > 0) {
          updatePageViewsChart(data.summary);
        }

      } catch (error) {
        console.error('Error loading page views chart:', error);
      }
    }

    // Update page views chart
    function updatePageViewsChart(summaryData) {
      const ctx = document.getElementById('pageViewsChart').getContext('2d');

      if (pageViewsChart) {
        pageViewsChart.destroy();
      }

      const labels = summaryData.map(day => {
        const date = new Date(day.date);
        return date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' });
      });

      const views = summaryData.map(day => day.total_views || 0);
      const visitors = summaryData.map(day => day.unique_visitors || 0);

      pageViewsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Page Views',
              data: views,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Unique Visitors',
              data: visitors,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function (value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // Update traffic sources chart
    function updateTrafficSourcesChart(trafficData) {
      const ctx = document.getElementById('trafficSourcesChart').getContext('2d');

      if (trafficSourcesChart) {
        trafficSourcesChart.destroy();
      }

      const labels = trafficData.map(source => `${source.source} (${source.medium})`);
      const data = trafficData.map(source => source.visits);
      const colors = trafficData.map(source => getTrafficSourceColor(source.source));

      trafficSourcesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true
              }
            }
          }
        }
      });
    }

    // Helper functions
    function getTrafficSourceIcon(source) {
      switch (source.toLowerCase()) {
        case 'google': return 'source-google';
        case 'facebook': return 'source-facebook';
        case 'direct': return 'source-direct';
        default: return 'source-other';
      }
    }

    function getTrafficSourceEmoji(source) {
      switch (source.toLowerCase()) {
        case 'google': return 'üîç';
        case 'facebook': return 'üìò';
        case 'direct': return 'üîó';
        case 'referral': return 'üåê';
        default: return 'üìä';
      }
    }

    function getTrafficSourceColor(source) {
      switch (source.toLowerCase()) {
        case 'google': return '#ea4335';
        case 'facebook': return '#1877f2';
        case 'direct': return '#64748b';
        case 'referral': return '#10b981';
        default: return '#f59e0b';
      }
    }

    function formatDuration(seconds) {
      if (!seconds || seconds < 0) return '0s';

      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);

      if (minutes > 0) {
        return `${minutes}m ${remainingSeconds}s`;
      } else {
        return `${remainingSeconds}s`;
      }
    }

    function setAnalyticsError(message) {
      const errorElements = document.querySelectorAll('.analytics-content .loading');
      errorElements.forEach(el => {
        el.textContent = message;
        el.classList.add('error');
      });
    }

    // Analytics action functions
    function refreshAnalytics() {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        showNotification('üîí Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ refresh analytics', 'warning');
        showSupabaseAuth();
        return;
      }

      clearAnalyticsRefreshTimers();
      showNotification('üîÑ ƒêang refresh analytics data...', 'info');
      resetAnalyticsState();

      initAnalytics().catch(error => {
        console.error('Analytics refresh failed:', error);
        showNotification('‚ùå Refresh analytics th·∫•t b·∫°i', 'error');
      });
    }

    function exportAnalytics() {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        showNotification('üîí Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ export analytics', 'warning');
        return;
      }
      showNotification('üìä T√≠nh nƒÉng export s·∫Ω s·ªõm c√≥...', 'info');
    }

    function showAnalyticsDetails() {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        showNotification('üîí Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem chi ti·∫øt analytics', 'warning');
        return;
      }
      showNotification('üîç T√≠nh nƒÉng chi ti·∫øt s·∫Ω s·ªõm c√≥...', 'info');
    }

    // Period selector handler
    document.addEventListener('change', function (e) {
      if (e.target.id === 'pageViewsPeriod') {
        const days = parseInt(e.target.value);
        loadPageViewsChart(days);
      }
    });

    // Kh√¥ng t·ª± ƒë·ªông kh·ªüi t·∫°o analytics khi ch∆∞a ƒëƒÉng nh·∫≠p

  </script>

  <!-- Help Modal -->
  <div id="helpModal" class="help-modal" onclick="handleHelpModalBackdrop(event)">
    <div class="help-modal-content" onclick="event.stopPropagation()">
      <div class="help-modal-header">
        <h2 class="help-modal-title">üìö H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng Admin Panel</h2>
        <button class="help-modal-close" onclick="hideHelpModal()">√ó</button>
      </div>

      <div class="help-nav">
        <div class="help-nav-item active" onclick="showHelpSection('overview')">üè† T·ªïng quan</div>
        <div class="help-nav-item" onclick="showHelpSection('articles')">üìù Qu·∫£n l√Ω b√†i vi·∫øt</div>
        <div class="help-nav-item" onclick="showHelpSection('compose')">‚úçÔ∏è Vi·∫øt b√†i</div>
        <div class="help-nav-item" onclick="showHelpSection('users')">üë• Ng∆∞·ªùi d√πng</div>
        <div class="help-nav-item" onclick="showHelpSection('search-console')">üîç Google Search Console</div>
        <div class="help-nav-item" onclick="showHelpSection('tips')">üí° M·∫πo hay</div>
      </div>

      <div class="help-modal-body">
        <div class="help-content">

          <!-- Overview Section -->
          <div id="help-overview" class="help-section active">
            <h3>üè† T·ªïng quan h·ªá th·ªëng</h3>
            <p>Admin Panel l√† h·ªá th·ªëng qu·∫£n l√Ω n·ªôi dung cho website B·∫£o Hi·ªÉm B·∫£o Vi·ªát ƒê√† N·∫µng. B·∫°n c√≥ th·ªÉ qu·∫£n l√Ω b√†i
              vi·∫øt, theo d√µi th·ªëng k√™ v√† x·ª≠ l√Ω ƒëƒÉng k√Ω t·ª´ kh√°ch h√†ng.</p>

            <div class="help-feature">
              <div class="help-feature-title">üìä Dashboard Th·ªëng k√™</div>
              <p>Xem t·ªïng quan v·ªÅ:</p>
              <ul>
                <li><strong>T·ªïng b√†i vi·∫øt:</strong> S·ªë l∆∞·ª£ng b√†i vi·∫øt trong h·ªá th·ªëng</li>
                <li><strong>ƒê√£ xu·∫•t b·∫£n:</strong> B√†i vi·∫øt ƒëang hi·ªÉn th·ªã tr√™n website</li>
                <li><strong>B√†i nh√°p:</strong> B√†i vi·∫øt ch∆∞a xu·∫•t b·∫£n</li>
                <li><strong>Ng∆∞·ªùi ƒëƒÉng k√Ω:</strong> S·ªë l∆∞·ª£ng kh√°ch h√†ng quan t√¢m</li>
              </ul>
            </div>

            <h4>üöÄ T√≠nh nƒÉng n·ªïi b·∫≠t</h4>
            <ul>
              <li><strong>Real-time:</strong> Th·ªëng k√™ c·∫≠p nh·∫≠t t·ª± ƒë·ªông</li>
              <li><strong>Cache th√¥ng minh:</strong> T·∫£i nhanh v·ªõi b·ªô nh·ªõ ƒë·ªám</li>
              <li><strong>Responsive:</strong> S·ª≠ d·ª•ng ƒë∆∞·ª£c tr√™n m·ªçi thi·∫øt b·ªã</li>
              <li><strong>B·∫£o m·∫≠t:</strong> Phi√™n l√†m vi·ªác an to√†n 30 ph√∫t</li>
            </ul>
          </div>

          <!-- Articles Section -->
          <div id="help-articles" class="help-section">
            <h3>üìù Qu·∫£n l√Ω b√†i vi·∫øt</h3>
            <p>Qu·∫£n l√Ω to√†n b·ªô n·ªôi dung b√†i vi·∫øt c·ªßa website v·ªõi c√°c t√≠nh nƒÉng powerful.</p>

            <h4>üîç Danh s√°ch b√†i vi·∫øt</h4>
            <div class="help-feature">
              <div class="help-feature-title">üìã Th√¥ng tin hi·ªÉn th·ªã</div>
              <ul>
                <li><strong>Ti√™u ƒë·ªÅ:</strong> T√™n b√†i vi·∫øt</li>
                <li><strong>Danh m·ª•c:</strong> Ph√¢n lo·∫°i b√†i vi·∫øt</li>
                <li><strong>Tr·∫°ng th√°i:</strong> Published (ƒë√£ xu·∫•t b·∫£n) ho·∫∑c Draft (nh√°p)</li>
                <li><strong>Ng√†y t·∫°o:</strong> Th·ªùi gian t·∫°o b√†i</li>
                <li><strong>Thao t√°c:</strong> S·ª≠a ho·∫∑c X√≥a b√†i vi·∫øt</li>
              </ul>
            </div>

            <h4>üìÑ Ph√¢n trang th√¥ng minh</h4>
            <div class="help-step">
              <strong>T√≠nh nƒÉng Pagination:</strong>
              <ul>
                <li>Hi·ªÉn th·ªã 10/20/50/100 b√†i vi·∫øt m·ªói trang</li>
                <li>ƒêi·ªÅu h∆∞·ªõng: ƒê·∫ßu, Tr∆∞·ªõc, Sau, Cu·ªëi</li>
                <li>Cache th√¥ng minh: Trang ƒë√£ xem load instant</li>
                <li>Prefetch: T·ª± ƒë·ªông t·∫£i s·∫µn trang ti·∫øp theo</li>
              </ul>
            </div>

            <h4>‚ö° T·ªëi ∆∞u hi·ªáu su·∫•t</h4>
            <ul>
              <li><strong>Single Query:</strong> G·ªôp count v√† data trong 1 l·∫ßn truy v·∫•n</li>
              <li><strong>Selective Fields:</strong> Ch·ªâ t·∫£i tr∆∞·ªùng c·∫ßn thi·∫øt</li>
              <li><strong>Background Prefetch:</strong> T·∫£i tr∆∞·ªõc trang ti·∫øp theo</li>
              <li><strong>Smart Cache:</strong> Cache 2 ph√∫t cho m·ªói trang</li>
            </ul>

            <div class="help-warning">
              <div class="help-warning-title">‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng</div>
              <p>T√≠nh nƒÉng x√≥a b√†i vi·∫øt hi·ªán ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. S·ª≠ d·ª•ng t√≠nh nƒÉng s·ª≠a ƒë·ªÉ thay ƒë·ªïi tr·∫°ng th√°i b√†i vi·∫øt
                thay v√¨ x√≥a.</p>
            </div>
          </div>

          <!-- Compose Section -->
          <div id="help-compose" class="help-section">
            <h3>‚úçÔ∏è Vi·∫øt v√† ch·ªânh s·ª≠a b√†i vi·∫øt</h3>
            <p>Tr√¨nh so·∫°n th·∫£o b√†i vi·∫øt m·∫°nh m·∫Ω v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng c·ªßa m·ªôt CMS chuy√™n nghi·ªáp.</p>

            <h4>üìù TinyMCE Editor</h4>
            <div class="help-feature">
              <div class="help-feature-title">üõ†Ô∏è C√¥ng c·ª• so·∫°n th·∫£o</div>
              <ul>
                <li><strong>Rich Text:</strong> Format vƒÉn b·∫£n ƒëa d·∫°ng</li>
                <li><strong>Insert Media:</strong> Th√™m h√¨nh ·∫£nh, video, links</li>
                <li><strong>Table Editor:</strong> T·∫°o v√† ch·ªânh s·ª≠a b·∫£ng</li>
                <li><strong>Code View:</strong> Ch·ªânh s·ª≠a HTML tr·ª±c ti·∫øp</li>
                <li><strong>Auto-save:</strong> T·ª± ƒë·ªông l∆∞u nh√°p</li>
              </ul>
            </div>

            <h4>üñºÔ∏è Qu·∫£n l√Ω h√¨nh ·∫£nh</h4>
            <div class="help-step">
              <strong>Upload v√† s·ª≠ d·ª•ng ·∫£nh:</strong>
              <ol>
                <li>Click "üì∑ Qu·∫£n l√Ω h√¨nh ·∫£nh" ƒë·ªÉ m·ªü tr√¨nh qu·∫£n l√Ω</li>
                <li>K√©o th·∫£ ho·∫∑c click ƒë·ªÉ upload ·∫£nh m·ªõi</li>
                <li>Click "Insert" ƒë·ªÉ ch√®n ·∫£nh v√†o n·ªôi dung</li>
                <li>Click "Remove" ƒë·ªÉ x√≥a ·∫£nh kh·ªèi th∆∞ vi·ªán</li>
              </ol>
            </div>

            <h4>üíæ L∆∞u b√†i vi·∫øt</h4>
            <ul>
              <li><strong>Save Draft:</strong> L∆∞u nh√°p ƒë·ªÉ ch·ªânh s·ª≠a sau</li>
              <li><strong>Save & Publish:</strong> Xu·∫•t b·∫£n lu√¥n l√™n website</li>
              <li><strong>Auto Deploy:</strong> T·ª± ƒë·ªông c·∫≠p nh·∫≠t website khi publish</li>
            </ul>

            <h4>üîí B·∫£o v·ªá d·ªØ li·ªáu</h4>
            <div class="help-feature">
              <div class="help-feature-title">‚ö†Ô∏è Unsaved Changes Detection</div>
              <p>H·ªá th·ªëng t·ª± ƒë·ªông ph√°t hi·ªán thay ƒë·ªïi ch∆∞a l∆∞u v√† c·∫£nh b√°o khi:</p>
              <ul>
                <li>R·ªùi kh·ªèi trang (F5, ƒë√≥ng tab)</li>
                <li>Click Dashboard ho·∫∑c ƒêƒÉng xu·∫•t</li>
                <li>Click Clear Form</li>
              </ul>
              <p>Modal s·∫Ω hi·ªán v·ªõi 3 l·ª±a ch·ªçn: <strong>L∆∞u v√† ti·∫øp t·ª•c</strong>, <strong>B·ªè qua thay ƒë·ªïi</strong>,
                <strong>H·ªßy b·ªè</strong>
              </p>
            </div>
          </div>

          <!-- Users Section -->
          <div id="help-users" class="help-section">
            <h3>üë• Qu·∫£n l√Ω ng∆∞·ªùi ƒëƒÉng k√Ω</h3>
            <p>Theo d√µi v√† qu·∫£n l√Ω danh s√°ch kh√°ch h√†ng quan t√¢m ƒë·∫øn d·ªãch v·ª• b·∫£o hi·ªÉm.</p>

            <h4>üìã Th√¥ng tin ng∆∞·ªùi ƒëƒÉng k√Ω</h4>
            <div class="help-feature">
              <div class="help-feature-title">üìä D·ªØ li·ªáu thu th·∫≠p</div>
              <ul>
                <li><strong>H·ªç t√™n:</strong> Th√¥ng tin c√° nh√¢n</li>
                <li><strong>Email:</strong> ƒê·ªãa ch·ªâ li√™n h·ªá</li>
                <li><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> Th√¥ng tin li√™n l·∫°c</li>
                <li><strong>D·ªãch v·ª• quan t√¢m:</strong> Lo·∫°i b·∫£o hi·ªÉm</li>
                <li><strong>Th·ªùi gian ƒëƒÉng k√Ω:</strong> Ng√†y g·ª≠i form</li>
              </ul>
            </div>

            <h4>üîÑ T·ª± ƒë·ªông c·∫≠p nh·∫≠t</h4>
            <ul>
              <li>D·ªØ li·ªáu ƒë·ªìng b·ªô realtime t·ª´ website</li>
              <li>Th·ªëng k√™ t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr√™n Dashboard</li>
              <li>Xu·∫•t d·ªØ li·ªáu ƒë·ªÉ li√™n h·ªá kh√°ch h√†ng</li>
            </ul>

            <div class="help-warning">
              <div class="help-warning-title">üîí B·∫£o m·∫≠t th√¥ng tin</div>
              <p>Th√¥ng tin kh√°ch h√†ng ƒë∆∞·ª£c b·∫£o m·∫≠t theo chu·∫©n GDPR. Ch·ªâ s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch t∆∞ v·∫•n b·∫£o hi·ªÉm.</p>
            </div>
          </div>

          <!-- Search Console Section -->
          <div id="help-search-console" class="help-section">
            <h3>üîç Google Search Console</h3>
            <p>Google Search Console (GSC) gi√∫p b·∫°n hi·ªÉu website xu·∫•t hi·ªán nh∆∞ th·∫ø n√†o tr√™n k·∫øt qu·∫£ t√¨m ki·∫øm c·ªßa Google
              v√† ph√°t hi·ªán c√°c v·∫•n ƒë·ªÅ SEO s·ªõm.</p>

            <h4>üìò C√°c ch·ªâ s·ªë c·ªët l√µi</h4>
            <div class="help-feature">
              <div class="help-feature-title">üìà Hi·ªáu su·∫•t t√¨m ki·∫øm</div>
              <ul>
                <li><strong>Click:</strong> S·ªë l·∫ßn ng∆∞·ªùi d√πng nh·∫•p v√†o k·∫øt qu·∫£ c·ªßa b·∫°n.</li>
                <li><strong>Impression:</strong> S·ªë l·∫ßn trang c·ªßa b·∫°n ƒë∆∞·ª£c hi·ªÉn th·ªã trong k·∫øt qu·∫£ t√¨m ki·∫øm.</li>
                <li><strong>CTR trung b√¨nh:</strong> T·ª∑ l·ªá = Click √∑ Impression. CTR cao ch·ª©ng t·ªè ti√™u ƒë·ªÅ/m√¥ t·∫£ h·∫•p d·∫´n.
                </li>
                <li><strong>V·ªã tr√≠ trung b√¨nh:</strong> Th·ª© h·∫°ng trung b√¨nh c·ªßa trang ho·∫∑c t·ª´ kh√≥a tr√™n Google.</li>
              </ul>
            </div>

            <div class="help-feature">
              <div class="help-feature-title">üß≠ B·ªô l·ªçc quan tr·ªçng</div>
              <ul>
                <li><strong>Truy v·∫•n (Queries):</strong> T·ª´ kh√≥a ng∆∞·ªùi d√πng t√¨m ki·∫øm tr∆∞·ªõc khi v√†o website.</li>
                <li><strong>Trang (Pages):</strong> Nh·ªØng URL ƒëang thu h√∫t traffic t·ª± nhi√™n.</li>
                <li><strong>Qu·ªëc gia & Thi·∫øt b·ªã:</strong> So s√°nh hi·ªáu su·∫•t theo t·ª´ng th·ªã tr∆∞·ªùng v√† lo·∫°i thi·∫øt b·ªã.</li>
                <li><strong>Search Appearance:</strong> Ki·ªÉm tra c√°c ƒë·ªãnh d·∫°ng hi·ªÉn th·ªã ƒë·∫∑c bi·ªát (FAQ, Breadcrumb,
                  v.v.).</li>
              </ul>
            </div>

            <h4>üõ† B√°o c√°o T√≠nh nƒÉng & Bao ph·ªß</h4>
            <div class="help-step">
              <strong>B√°o c√°o Bao ph·ªß (Coverage):</strong>
              <ol>
                <li><strong>Valid:</strong> Trang ƒë√£ ƒë∆∞·ª£c Google index b√¨nh th∆∞·ªùng.</li>
                <li><strong>Warning:</strong> Trang index nh∆∞ng c√≥ v·∫•n ƒë·ªÅ c·∫ßn t·ªëi ∆∞u.</li>
                <li><strong>Error:</strong> Trang kh√¥ng ƒë∆∞·ª£c index ‚Äì c·∫ßn ki·ªÉm tra m√¥ t·∫£ l·ªói c·ª• th·ªÉ.</li>
                <li><strong>Excluded:</strong> Trang b·ªã lo·∫°i kh·ªèi ch·ªâ m·ª•c (noindex, tr√πng l·∫∑p, redirect...).</li>
              </ol>
            </div>

            <div class="help-feature">
              <div class="help-feature-title">‚ú® Enhancements</div>
              <ul>
                <li><strong>Core Web Vitals:</strong> Theo d√µi t·ªëc ƒë·ªô t·∫£i v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.</li>
                <li><strong>S∆° ƒë·ªì trang (Sitemaps):</strong> ƒê·∫£m b·∫£o Google bi·∫øt ƒë·∫ßy ƒë·ªß c·∫•u tr√∫c website.</li>
                <li><strong>Breadcrumb / FAQ:</strong> Ki·ªÉm tra vi·ªác tri·ªÉn khai schema c·∫£i thi·ªán hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m
                  ki·∫øm.</li>
              </ul>
            </div>

            <h4>üöÄ C√°ch s·ª≠ d·ª•ng nhanh</h4>
            <div class="help-step">
              <strong>3 b∆∞·ªõc m·ªói tu·∫ßn:</strong>
              <ol>
                <li>M·ªü b√°o c√°o Hi·ªáu su·∫•t & l·ªçc theo 7 ng√†y g·∫ßn nh·∫•t.</li>
                <li>Xem truy v·∫•n/t·ª´ kh√≥a c√≥ xu h∆∞·ªõng tƒÉng ho·∫∑c gi·∫£m m·∫°nh.</li>
                <li>Nh·∫•p v√†o t·ª´ng trang ƒë·ªÉ t·ªëi ∆∞u ti√™u ƒë·ªÅ, n·ªôi dung v√† internal link.</li>
              </ol>
            </div>

            <div class="help-warning">
              <div class="help-warning-title">üîî G·ª£i √Ω theo d√µi</div>
              <ul>
                <li>Thi·∫øt l·∫≠p email th√¥ng b√°o trong GSC ƒë·ªÉ nh·∫≠n c·∫£nh b√°o l·ªói m·ªõi.</li>
                <li>T√°i g·ª≠i sitemap sau khi th√™m nhi·ªÅu b√†i vi·∫øt m·ªõi.</li>
                <li>Ki·ªÉm tra m·ª•c Manual Actions n·∫øu traffic gi·∫£m b·∫•t th∆∞·ªùng.</li>
              </ul>
            </div>
          </div>

          <!-- Tips Section -->
          <div id="help-tips" class="help-section">
            <h3>üí° M·∫πo v√† th·ªß thu·∫≠t</h3>
            <p>Nh·ªØng tips h·ªØu √≠ch ƒë·ªÉ s·ª≠ d·ª•ng Admin Panel hi·ªáu qu·∫£ nh·∫•t.</p>

            <h4>‚ö° TƒÉng t·ªëc l√†m vi·ªác</h4>
            <div class="help-step">
              <strong>Keyboard Shortcuts:</strong>
              <ul>
                <li><span class="help-shortcut">Ctrl + S</span> L∆∞u nh√°p nhanh</li>
                <li><span class="help-shortcut">Ctrl + Enter</span> Publish b√†i vi·∫øt</li>
                <li><span class="help-shortcut">Esc</span> ƒê√≥ng modal</li>
                <li><span class="help-shortcut">F5</span> Refresh page (c√≥ c·∫£nh b√°o unsaved)</li>
              </ul>
            </div>

            <h4>üéØ Best Practices</h4>
            <div class="help-feature">
              <div class="help-feature-title">üìù Vi·∫øt b√†i hi·ªáu qu·∫£</div>
              <ul>
                <li><strong>SEO Title:</strong> Ti√™u ƒë·ªÅ 50-60 k√Ω t·ª±, c√≥ t·ª´ kh√≥a</li>
                <li><strong>Meta Description:</strong> M√¥ t·∫£ 150-160 k√Ω t·ª±</li>
                <li><strong>Headings:</strong> S·ª≠ d·ª•ng H1, H2, H3 c√≥ c·∫•u tr√∫c</li>
                <li><strong>Images:</strong> Alt text cho SEO v√† khuy·∫øt t·∫≠t</li>
                <li><strong>Internal Links:</strong> Li√™n k·∫øt n·ªôi b·ªô tƒÉng SEO</li>
              </ul>
            </div>

            <h4>üöÄ Performance Tips</h4>
            <ul>
              <li><strong>Image Optimization:</strong> Compress ·∫£nh tr∆∞·ªõc khi upload</li>
              <li><strong>Cache Usage:</strong> ƒê·ªÉ cache work, kh√¥ng refresh li√™n t·ª•c</li>
              <li><strong>Batch Operations:</strong> L√†m nhi·ªÅu vi·ªác c√πng l√∫c</li>
              <li><strong>Regular Cleanup:</strong> X√≥a ·∫£nh kh√¥ng d√πng trong Image Manager</li>
            </ul>

            <h4>üõ°Ô∏è B·∫£o m·∫≠t</h4>
            <div class="help-warning">
              <div class="help-warning-title">üîê An to√†n t√†i kho·∫£n</div>
              <ul>
                <li>ƒêƒÉng xu·∫•t khi kh√¥ng s·ª≠ d·ª•ng</li>
                <li>Kh√¥ng chia s·∫ª th√¥ng tin ƒëƒÉng nh·∫≠p</li>
                <li>Phi√™n l√†m vi·ªác t·ª± ƒë·ªông h·∫øt h·∫°n sau 30 ph√∫t</li>
                <li>Ki·ªÉm tra URL lu√¥n l√† domain ch√≠nh th·ª©c</li>
              </ul>
            </div>

            <h4>üÜò X·ª≠ l√Ω s·ª± c·ªë</h4>
            <div class="help-step">
              <strong>Khi g·∫∑p l·ªói:</strong>
              <ol>
                <li><strong>Refresh page:</strong> F5 ƒë·ªÉ reload</li>
                <li><strong>Clear cache:</strong> Ctrl + F5 hard refresh</li>
                <li><strong>Check network:</strong> Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng</li>
                <li><strong>Relogin:</strong> ƒêƒÉng xu·∫•t v√† ƒëƒÉng nh·∫≠p l·∫°i</li>
              </ol>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Admin Integration Script -->
  <script>
    // Integrated Admin Dashboard System
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize admin system with login integration
      console.log('üöÄ Initializing Admin Dashboard System...');

      // Global admin system reference
      window.adminDashboard = {
        isReady: false,
        keyManager: null,
        analytics: null
      };

      // Initialize analytics with admin authentication
      async function initializeAdminAnalytics() {
        try {
          if (!window.adminAuthManager || !window.adminAuthManager.isAuthenticated()) {
            console.warn('‚ö†Ô∏è AdminAuthManager ch∆∞a s·∫µn s√†ng cho analytics');
            return;
          }

          const headers = window.adminAuthManager.getAuthHeaders();
          const analyticsToken = headers.Authorization ?
            headers.Authorization.replace('Bearer ', '') : null;

          if (analyticsToken && window.userAnalytics) {
            window.userAnalytics.updateAuthKey(analyticsToken);
            window.adminDashboard.analytics = window.userAnalytics;
            console.log('üìä Admin analytics initialized');
          }

        } catch (error) {
          console.warn('‚ö†Ô∏è Could not initialize admin analytics:', error);
        }
      }

      // Show welcome message after login
      function showWelcomeMessage(adminInfo) {
        // Create welcome notification
        const welcomeDiv = document.createElement('div');
        welcomeDiv.className = 'admin-welcome-notification';
        welcomeDiv.innerHTML = `
          <div class="welcome-icon">üëã</div>
          <div class="welcome-content">
            <h4>Welcome to Admin Dashboard!</h4>
            <p>Logged in as: ${adminInfo.username || 'Admin'}</p>
            <small>All systems initialized and ready</small>
          </div>
          <button onclick="this.parentElement.remove()" class="welcome-close">√ó</button>
        `;

        // Add styles for welcome notification
        const welcomeStyles = document.createElement('style');
        welcomeStyles.textContent = `
          .admin-welcome-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 10000;
            max-width: 350px;
            animation: slideInRight 0.5s ease-out;
          }

          .welcome-icon {
            font-size: 2rem;
          }

          .welcome-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            font-weight: 600;
          }

          .welcome-content p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
          }

          .welcome-content small {
            font-size: 0.8rem;
            opacity: 0.8;
          }

          .welcome-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 50%;
            margin-left: auto;
          }

          .welcome-close:hover {
            background: rgba(255, 255, 255, 0.3);
          }

          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `;

        document.head.appendChild(welcomeStyles);
        document.body.appendChild(welcomeDiv);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (welcomeDiv.parentElement) {
            welcomeDiv.remove();
            welcomeStyles.remove();
          }
        }, 5000);
      }

      // Helper function to get admin key for dashboard operations
      window.getAdminKey = async function (keyType = 'access_token') {
        if (!window.adminAuthManager || !window.adminAuthManager.isAuthenticated()) {
          throw new Error('Admin auth system not ready');
        }

        const headers = window.adminAuthManager.getAuthHeaders();
        const bearerToken = headers.Authorization ? headers.Authorization.replace('Bearer ', '') : null;

        switch (keyType) {
          case 'headers':
            return headers;
          case 'apikey':
          case 'anon_key':
            return headers.apikey;
          case 'access_token':
          case 'jwt':
          default:
            return bearerToken;
        }
      };

      // Helper function to check if admin is logged in
      window.isAdminLoggedIn = function () {
        return !!(window.adminAuthManager && window.adminAuthManager.isAuthenticated());
      };

      console.log('üéØ Admin dashboard system initialized, waiting for login...');
    });

    // Handle logout
    document.addEventListener('admin-logout', function () {
      console.log('üëã Admin logout detected, cleaning up...');

      // Reset admin dashboard state
      window.adminDashboard.isReady = false;
      window.adminDashboard.keyManager = null;
      window.adminDashboard.analytics = null;

      // Clear any admin-specific data
      // This will be handled by the reload in AdminLoginSystem
      resetAnalyticsState();
      clearAnalyticsRefreshTimers();
    });

    // === Supabase Authentication Integration ===

    // Update user profile in sidebar
    function updateUserProfile(user) {
      // Update user name
      const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';
      document.querySelectorAll('.user-name').forEach(el => {
        el.textContent = userName;
      });

      // Update user email
      document.querySelectorAll('.user-email').forEach(el => {
        el.textContent = user.email;
      });

      // Update user role
      const userRole = user.user_metadata?.role || 'admin';
      document.querySelectorAll('.user-role').forEach(el => {
        el.textContent = userRole;
      });

      // Update user initials
      const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      document.querySelectorAll('.user-initials').forEach(el => {
        el.textContent = initials;
      });

      console.log('üë§ User profile updated:', userName);
    }

    // Clear user profile
    function clearUserProfile() {
      document.querySelectorAll('.user-name').forEach(el => {
        el.textContent = 'Loading...';
      });

      document.querySelectorAll('.user-email').forEach(el => {
        el.textContent = 'user@domain.com';
      });

      document.querySelectorAll('.user-role').forEach(el => {
        el.textContent = 'admin';
      });

      document.querySelectorAll('.user-initials').forEach(el => {
        el.textContent = 'AD';
      });
    }

    // Supabase authentication functions
    function showSupabaseAuth() {
      if (adminAuth) {
        adminAuth.showLoginModal();
      } else if (window.adminAuthManager) {
        window.adminAuthManager.showLoginModal();
      } else {
        console.error('Admin Authentication Manager not available');
      }
    }

    async function handleSupabaseLogout() {
      if (!adminAuth) {
        console.warn('‚ö†Ô∏è AdminAuthManager ch∆∞a s·∫µn s√†ng');
        return;
      }

      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        try {
          await adminAuth.logout();
          console.log('‚úÖ Admin logout successful');
        } catch (error) {
          console.error('‚ùå Logout failed:', error);
        }
      }
    }

    function showUserProfile() {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        console.warn('‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p');
        return;
      }

      const user = adminAuth.getCurrentUser();
      alert(`User Profile:\n\nName: ${user.user_metadata?.full_name || 'N/A'}\nEmail: ${user.email}\nRole: ${user.user_metadata?.role || 'admin'}\nLast Sign In: ${new Date(user.last_sign_in_at).toLocaleString()}`);
    }

    // Admin Authentication & API Managers
    let adminAuth = null;
    let adminAPI = null;
    let isAdminMode = false;

    // Initialize Admin Authentication & API
    async function initializeAdminAuth() {
      try {
        // Initialize Auth Manager
        adminAuth = new AdminAuthManager();
        await adminAuth.initialize();

        // L∆∞u tr·ªØ global ƒë·ªÉ t√°i s·ª≠ d·ª•ng
        window.adminAuthManager = adminAuth;

        // Get supabase client if available (may be null if initialization had issues)
        try {
          const client = adminAuth.getSupabaseClient();
          if (client) {
            supabaseClient = client; // Update local variable
            window.supabaseClient = client; // Also set global
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Supabase client not available yet:', e.message);
        }

        // Initialize API Manager (only if auth is working)
        try {
          adminAPI = new AdminAPIManager();
          await adminAPI.initialize(adminAuth);
        } catch (apiError) {
          console.warn('‚ö†Ô∏è API Manager initialization failed:', apiError.message);
        }

        // Check current session
        const isAuthenticated = await adminAuth.checkCurrentSession();
        updateAuthButton(isAuthenticated);

        if (isAuthenticated) {
          isAdminMode = true;
          const currentUser = adminAuth.getCurrentUser();
          console.log('‚úÖ Admin ƒë√£ ƒëƒÉng nh·∫≠p:', currentUser.email);
          updateUserProfile(currentUser);
          try {
            await adminAPI.logAdminAction('dashboard_access', { ip: 'auto' });
          } catch (e) {
            console.warn('‚ö†Ô∏è Could not log admin action:', e.message);
          }
          await handleAuthenticatedState();
        } else {
          console.log('‚ÑπÔ∏è Ch∆∞a ƒëƒÉng nh·∫≠p - y√™u c·∫ßu ƒëƒÉng nh·∫≠p Admin');
          isAdminMode = false;
          lockDashboardForGuest();
          // Ensure modal shows even if there were initialization issues
          setTimeout(() => {
            if (adminAuth && typeof adminAuth.showLoginModal === 'function') {
              adminAuth.showLoginModal();
            }
          }, 100);
        }

      } catch (error) {
        console.error('‚ùå L·ªói kh·ªüi t·∫°o Admin system:', error);
        isAdminMode = false;
        // Still try to show login modal even on error
        if (adminAuth && typeof adminAuth.showLoginModal === 'function') {
          setTimeout(() => adminAuth.showLoginModal(), 200);
        }
      }
    }

    async function handleAuthenticatedState() {
      try {
        toggleAuthSections(true);
        const client = adminAuth.getSupabaseClient();
        if (client) {
          supabaseClient = client; // Update local variable
          window.supabaseClient = client; // Also set global
        }
        updateUserProfile(adminAuth.getCurrentUser());
        resetAnalyticsState();
        await refreshDashboardWithAuth();
      } catch (error) {
        console.error('‚ùå L·ªói x·ª≠ l√Ω sau khi ƒëƒÉng nh·∫≠p:', error);
      }
    }

    function lockDashboardForGuest() {
      toggleAuthSections(false);
      clearUserProfile();
      resetAnalyticsState();
      document.querySelectorAll('.admin-feature').forEach(element => {
        element.classList.add('disabled');
        element.setAttribute('disabled', 'disabled');
      });
    }

    function toggleAuthSections(isAuthenticated) {
      const profileSection = document.querySelector('.user-profile');
      const signInSection = document.querySelector('.auth-signin');

      if (profileSection) {
        profileSection.style.display = isAuthenticated ? 'flex' : 'none';
      }

      if (signInSection) {
        signInSection.classList.toggle('auth-hidden', !!isAuthenticated);
      }
    }

    // Handle Auth Button Click
    function handleAuthAction() {
      if (adminAuth && adminAuth.isAuthenticated()) {
        // ƒêƒÉng xu·∫•t
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
          adminAuth.logout();
        }
      } else {
        // ƒêƒÉng nh·∫≠p
        adminAuth.showLoginModal();
      }
    }

    // Update Auth Button
    function updateAuthButton(isAuthenticated) {
      const authBtn = document.getElementById('adminAuthBtn');
      const authBtnText = document.getElementById('authBtnText');

      if (isAuthenticated) {
        authBtn.classList.add('logout');
        authBtnText.textContent = 'üö™ ƒêƒÉng xu·∫•t';
      } else {
        authBtn.classList.remove('logout');
        authBtnText.textContent = 'üîê ƒêƒÉng nh·∫≠p';
      }

      toggleAuthSections(isAuthenticated);
    }

    // Refresh Dashboard with Authentication
    async function refreshDashboardWithAuth(forceRefresh = true) {
      if (!adminAuth || !adminAuth.isAuthenticated()) {
        console.warn('‚ö†Ô∏è Kh√¥ng th·ªÉ refresh khi ch∆∞a ƒëƒÉng nh·∫≠p');
        return;
      }

      const supabaseClient = adminAuth.getSupabaseClient();
      if (supabaseClient) {
        window.supabaseClient = supabaseClient;
        supabase = supabaseClient; // Update legacy variable
      }
      console.log('üîÑ Refresh dashboard v·ªõi admin auth...');

      await Promise.allSettled([
        loadDashboardData(),
        loadOverviewStats(forceRefresh),
        loadArticles(currentArticlesPage),
        loadUsers()
      ]);

      if (typeof initAnalytics === 'function' && !analyticsInitialized) {
        setTimeout(() => {
          initAnalytics().catch(error => console.error('Analytics init failed:', error));
        }, 500);
      }
    }

    // Load Dashboard Data v·ªõi Authentication
    async function loadDashboardData() {
      if (!adminAPI || !adminAuth || !adminAuth.isAuthenticated()) {
        console.warn('‚ö†Ô∏è Admin API Manager ch∆∞a s·∫µn s√†ng ho·∫∑c ch∆∞a ƒëƒÉng nh·∫≠p');
        return;
      }

      try {
        console.log('üîÑ Loading dashboard data - Admin mode');

        // Get dashboard stats
        const stats = await adminAPI.getDashboardStats();
        console.log('üìä Dashboard stats:', stats);

        // Update UI based on mode
        updateDashboardMode(stats);

      } catch (error) {
        console.error('‚ùå Load dashboard data failed:', error);
      }
    }

    // Load Admin specific data
    async function loadAdminData() {
      try {
        const [analytics, users] = await Promise.all([
          adminAPI.getAnalyticsData(),
          adminAPI.getUserData()
        ]);

        console.log('üîê Admin data loaded:', { analytics: analytics.length, users: users.length });

        // Update charts and tables with admin data
        updateDashboardCharts(analytics);
        updateUserTable(users);

      } catch (error) {
        console.error('‚ùå Load admin data failed:', error);
      }
    }

    // Update dashboard mode indicator
    function updateDashboardMode(stats) {
      // Add visual indicators
      const modeIndicator = document.querySelector('.mode-indicator');
      if (modeIndicator) {
        const modeText = stats && stats.mode === 'admin' ? 'üîê Admin Mode' : 'üîí C·∫ßn ƒëƒÉng nh·∫≠p';
        modeIndicator.textContent = modeText;
      }
    }

    // Placeholder functions for chart updates
    function updateDashboardCharts(data) {
      console.log('üìà Updating charts with data:', data.length, 'records');
      // Implement your chart update logic here
    }

    function updateUserTable(users) {
      console.log('üë• Updating user table:', users.length, 'users');
      // Implement your user table update logic here
    }

    // Handle Logout
    function handleLogout() {
      isAdminMode = false;
      updateAuthButton(false);
      clearAnalyticsRefreshTimers();
      resetAnalyticsState();
      lockDashboardForGuest();
      console.log('‚úÖ ƒêƒÉng xu·∫•t th√†nh c√¥ng - y√™u c·∫ßu ƒëƒÉng nh·∫≠p l·∫°i');
      showSupabaseAuth();
    }

    // API Call Helper - T·ª± ƒë·ªông ch·ªçn auth method
    async function makeAPICall(url, options = {}) {
      try {
        if (!adminAuth || !adminAuth.isAuthenticated()) {
          throw new Error('Y√™u c·∫ßu ƒëƒÉng nh·∫≠p Admin ƒë·ªÉ g·ªçi API');
        }

        const authHeaders = adminAuth.getAuthHeaders();
        const headers = {
          'Content-Type': 'application/json',
          ...authHeaders,
          ...options.headers
        };

        console.log('üîê API call v·ªõi Admin token');

        const response = await fetch(url, {
          ...options,
          headers
        });

        return response;
      } catch (error) {
        console.error('‚ùå API call failed:', error);
        throw error;
      }
    }

    // Event Listeners for Auth
    window.addEventListener('adminLoginSuccess', (event) => {
      isAdminMode = true;
      updateAuthButton(true);
      if (event.detail?.user) {
        updateUserProfile(event.detail.user);
      }
      refreshDashboardWithAuth();
      console.log('‚úÖ Admin login success event received');
    });

    window.addEventListener('adminLogout', () => {
      handleLogout();
    });

    // Initialize on page load - removed duplicate initialization

    // Legacy support functions
    function logout() {
      if (adminAuth) {
        adminAuth.logout();
      } else {
        handleSupabaseLogout();
      }
    }

    // Expose global functions
    window.refreshDashboard = refreshDashboardWithAuth;
    window.handleLogout = handleLogout;
    window.makeAPICall = makeAPICall;
  </script>
</body>

</html>