#!/bin/bash

# ğŸ” Check GitHub Repository Permissions
echo "ğŸ” Checking Repository Permissions for GitHub Actions"
echo "===================================================="

echo ""
echo "ğŸ“‹ PERMISSIONS FIX APPLIED:"
echo "----------------------------"
echo "âœ… Added permissions to workflow:"
echo "   - contents: write (push to repo)"
echo "   - pages: write (deploy to Pages)"  
echo "   - id-token: write (authentication)"
echo ""
echo "âœ… Fixed git push command:"
echo "   - Changed from 'git push' to 'git push origin HEAD'"
echo "   - Added GITHUB_TOKEN environment variable"

echo ""
echo "ğŸ¯ NEXT STEPS TO VERIFY:"
echo "------------------------"
echo ""
echo "1ï¸âƒ£ Check Repository Settings:"
echo "   URL: https://github.com/Liam-and-Son-Group/baoviet-danang/settings/actions"
echo "   Workflow permissions should be: 'Read and write permissions'"
echo ""
echo "2ï¸âƒ£ Test Fixed Workflow:"
echo "   gh workflow run deploy-new-article.yml \\"
echo "     -f article_id=\"85bf05a9-edaa-40b3-96a6-12d27cff3c77\" \\"
echo "     -f article_filename=\"test-fix.html\""
echo ""
echo "3ï¸âƒ£ If still fails, use Personal Access Token:"
echo "   - Create PAT: https://github.com/settings/tokens"
echo "   - Add to secrets as PERSONAL_ACCESS_TOKEN"
echo "   - Use workflow: deploy-with-pat.yml"

echo ""
echo "ğŸš¨ COMMON ISSUES & SOLUTIONS:"
echo "-----------------------------"
echo ""
echo "âŒ Issue: Branch protection rules"
echo "âœ… Solution: Check Settings â†’ Branches, disable protection for Actions"
echo ""
echo "âŒ Issue: Repository visibility (private repo)"
echo "âœ… Solution: May need Personal Access Token for private repos"
echo ""
echo "âŒ Issue: Organization permissions"
echo "âœ… Solution: Organization may restrict Actions permissions"

echo ""
echo "ğŸ“Š WORKFLOW STATUS:"
echo "------------------"
echo "Original workflow: deploy-new-article.yml (with permissions fix)"
echo "Backup workflow: deploy-with-pat.yml (uses Personal Access Token)"

echo ""
echo "ğŸ¯ EXPECTED RESULT AFTER FIX:"
echo "-----------------------------"
echo "âœ… Checkout repository"
echo "âœ… Generate article HTML"  
echo "âœ… Update sitemap"
echo "âœ… Commit & push changes â† Should work now!"
echo "âœ… Deploy to GitHub Pages"

echo ""
echo "===================================================="
echo "ğŸ‰ Permissions fix applied! Test workflow now! ğŸš€"