<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Anon Key Manager</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }

    .result {
      margin: 10px 0;
      padding: 15px;
      border-radius: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #0056b3;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîë Anon Key Manager Test</h1>
    <p>Test utility ƒë·ªÉ ki·ªÉm tra Edge Function get-anon-key</p>

    <div class="test-section">
      <h3>üì° Direct Edge Function Call</h3>
      <p>G·ªçi tr·ª±c ti·∫øp Edge Function kh√¥ng qua Supabase Key Manager</p>
      <button onclick="testDirectCall()">Test Direct Call</button>
      <div id="directResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üîß Supabase Key Manager</h3>
      <p>Test th√¥ng qua SupabaseKeyManager class</p>
      <button onclick="testKeyManager()">Test Key Manager</button>
      <button onclick="clearCache()">Clear Cache</button>
      <button onclick="showCacheInfo()">Show Cache Info</button>
      <div id="managerResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>ÔøΩ Supply Anon Key</h3>
      <p>Manually supply anon key from Supabase Dashboard</p>
      <textarea id="anonKeyInput" placeholder="Paste your anon key from Supabase Dashboard here..."
        style="width: 100%; height: 80px; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; font-size: 12px;"></textarea>
      <div style="margin: 10px 0;">
        <button onclick="supplyKey()">Supply Key</button>
        <button onclick="supplyLongTerm()">Supply Long Term (24h)</button>
        <button onclick="testSuppliedKey()">Test Supplied Key</button>
      </div>
      <div id="supplyResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>ÔøΩüìä Analytics Integration</h3>
      <p>Test User Analytics v·ªõi anon key</p>
      <button onclick="testAnalytics()">Test Analytics</button>
      <div id="analyticsResult" class="result"></div>
    </div>

    <div class="test-section">
      <h3>üöÄ Full Integration Test</h3>
      <p>Test to√†n b·ªô flow: Key Manager ‚Üí Analytics ‚Üí Edge Function</p>
      <button onclick="testFullIntegration()">Run Full Test</button>
      <div id="integrationResult" class="result"></div>
    </div>
  </div>

  <script src="supabase-key-manager.js"></script>
  <script src="supply-anon-key.js"></script>
  <script src="user-analytics.js"></script>
  <script>
    const BASE_URL = 'https://fiaxrsiycswrwucthian.supabase.co';

    function showResult(elementId, content, type = 'info') {
      const element = document.getElementById(elementId);
      element.className = `result ${type}`;
      element.textContent = content;
    }

    function showLoading(elementId, message = 'Loading...') {
      const element = document.getElementById(elementId);
      element.className = 'result info loading';
      element.textContent = message;
    }

    async function testDirectCall() {
      showLoading('directResult', 'Testing direct Edge Function call...');

      try {
        // Test without auth header first
        console.log('üîÑ Testing without auth header...');
        let response = await fetch(`${BASE_URL}/functions/v1/get-anon-key`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', [...response.headers.entries()]);

        if (!response.ok) {
          const errorText = await response.text();
          console.log('Error response:', errorText);

          // Try with bootstrap key
          console.log('üîÑ Trying with bootstrap key...');
          const bootstrapKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpYXhyc2l5Y3N3cnd1Y3RoaWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDA2NDY3NjQsImV4cCI6MjAxNjIyMjc2NH0.bJhkUrUvKhQmNabgp8rqYYNKqglLpykUJ5wOhJHyqhE';

          response = await fetch(`${BASE_URL}/functions/v1/get-anon-key`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${bootstrapKey}`,
              'apikey': bootstrapKey
            }
          });
        }

        if (response.ok) {
          const data = await response.json();
          showResult('directResult',
            `‚úÖ Success!\n\nAnon Key: ${data.anon_key.substring(0, 50)}...\nCreated: ${data.created_at}\nUsage Count: ${data.usage_count}`,
            'success'
          );
        } else {
          const errorData = await response.json();
          showResult('directResult',
            `‚ùå Error ${response.status}\n\n${JSON.stringify(errorData, null, 2)}`,
            'error'
          );
        }
      } catch (error) {
        console.error('Direct call error:', error);
        showResult('directResult',
          `‚ùå Network Error\n\n${error.message}`,
          'error'
        );
      }
    }

    async function testKeyManager() {
      showLoading('managerResult', 'Testing Supabase Key Manager...');

      try {
        const keyManager = new SupabaseKeyManager();
        const anonKey = await keyManager.getAnonKey();

        showResult('managerResult',
          `‚úÖ Key Manager Success!\n\nAnon Key: ${anonKey.substring(0, 50)}...\nSource: ${keyManager.getCachedKey() ? 'Cache' : 'Edge Function'}`,
          'success'
        );
      } catch (error) {
        console.error('Key Manager error:', error);
        showResult('managerResult',
          `‚ùå Key Manager Error\n\n${error.message}`,
          'error'
        );
      }
    }

    function clearCache() {
      const keyManager = new SupabaseKeyManager();
      keyManager.clearCache();
      showResult('managerResult', 'üßπ Cache cleared successfully', 'info');
    }

    function showCacheInfo() {
      const keyManager = new SupabaseKeyManager();
      const cacheInfo = keyManager.getCacheInfo();

      if (cacheInfo) {
        showResult('managerResult',
          `üì¶ Cache Info\n\n${JSON.stringify(cacheInfo, null, 2)}`,
          'info'
        );
      } else {
        showResult('managerResult', 'üì¶ No cache data found', 'info');
      }
    }

    async function testAnalytics() {
      showLoading('analyticsResult', 'Testing User Analytics...');

      try {
        // Initialize analytics
        const analytics = new UserAnalytics({
          baseUrl: BASE_URL,
          trackingEnabled: true
        });

        // Test getting anon key
        const anonKey = await analytics.getAnonKey();

        if (anonKey) {
          showResult('analyticsResult',
            `‚úÖ Analytics Integration Success!\n\nAnon Key: ${anonKey.substring(0, 50)}...\nSession ID: ${analytics.sessionId}`,
            'success'
          );
        } else {
          showResult('analyticsResult',
            `‚ùå Analytics Error\n\nFailed to get anon key`,
            'error'
          );
        }
      } catch (error) {
        console.error('Analytics error:', error);
        showResult('analyticsResult',
          `‚ùå Analytics Error\n\n${error.message}`,
          'error'
        );
      }
    }

    async function testFullIntegration() {
      showLoading('integrationResult', 'Running full integration test...');

      const results = [];

      try {
        // Step 1: Test Key Manager
        results.push('üîß Testing Key Manager...');
        const keyManager = new SupabaseKeyManager();
        const anonKey = await keyManager.getAnonKey();
        results.push(`‚úÖ Key Manager: ${anonKey ? 'SUCCESS' : 'FAILED'}`);

        // Step 2: Test Analytics
        results.push('\nüìä Testing Analytics...');
        const analytics = new UserAnalytics({
          baseUrl: BASE_URL,
          trackingEnabled: true
        });

        const analyticsKey = await analytics.getAnonKey();
        results.push(`‚úÖ Analytics Key: ${analyticsKey ? 'SUCCESS' : 'FAILED'}`);

        // Step 3: Test tracking event
        results.push('\nüìà Testing Event Tracking...');
        analytics.trackPageView();
        results.push('‚úÖ Page view tracked');

        // Step 4: Test Edge Function call
        results.push('\nüöÄ Testing Edge Function...');
        const response = await fetch(`${BASE_URL}/functions/v1/track-user-behavior?type=summary&days=1`, {
          headers: {
            'Authorization': `Bearer ${anonKey}`,
            'apikey': anonKey
          }
        });

        if (response.ok) {
          const data = await response.json();
          results.push('‚úÖ Edge Function: SUCCESS');
          results.push(`üìä Active Users: ${data.active_users || 0}`);
        } else {
          results.push(`‚ùå Edge Function: ${response.status} ${response.statusText}`);
        }

        showResult('integrationResult',
          results.join('\n'),
          'success'
        );

      } catch (error) {
        results.push(`\n‚ùå Integration Error: ${error.message}`);
        showResult('integrationResult',
          results.join('\n'),
          'error'
        );
      }
    }

    // Supply Key Functions
    async function supplyKey() {
      const keyInput = document.getElementById('anonKeyInput');
      const anonKey = keyInput.value.trim();

      if (!anonKey) {
        showResult('supplyResult', '‚ùå Please paste an anon key', 'error');
        return;
      }

      showLoading('supplyResult', 'Supplying anon key...');

      try {
        const keyManager = new SupabaseKeyManager();
        const result = keyManager.supplyAnonKey(anonKey);

        showResult('supplyResult',
          `‚úÖ Key Supplied Successfully!\n\n${JSON.stringify(result, null, 2)}`,
          'success'
        );
      } catch (error) {
        showResult('supplyResult',
          `‚ùå Supply Failed\n\n${error.message}`,
          'error'
        );
      }
    }

    async function supplyLongTerm() {
      const keyInput = document.getElementById('anonKeyInput');
      const anonKey = keyInput.value.trim();

      if (!anonKey) {
        showResult('supplyResult', '‚ùå Please paste an anon key', 'error');
        return;
      }

      showLoading('supplyResult', 'Supplying long-term anon key...');

      try {
        const keyManager = new SupabaseKeyManager();
        const result = keyManager.setLongLivedKey(anonKey, 24);

        showResult('supplyResult',
          `‚úÖ Long-term Key Supplied!\n\nCache duration: 24 hours\n${JSON.stringify(result, null, 2)}`,
          'success'
        );
      } catch (error) {
        showResult('supplyResult',
          `‚ùå Long-term Supply Failed\n\n${error.message}`,
          'error'
        );
      }
    }

    async function testSuppliedKey() {
      showLoading('supplyResult', 'Testing supplied key...');

      try {
        const keyManager = new SupabaseKeyManager();

        // Get current key
        const currentKey = await keyManager.getAnonKey();
        if (!currentKey) {
          throw new Error('No key available - supply one first');
        }

        // Validate the key
        const validation = await keyManager.validateAnonKey(currentKey);

        // Get cache info
        const cacheInfo = keyManager.getCacheInfo();

        // Get all keys
        const allKeys = keyManager.getAllKeys();

        const result = {
          current_key: currentKey.substring(0, 50) + '...',
          validation: validation,
          cache_info: cacheInfo,
          all_keys: allKeys
        };

        if (validation.valid) {
          showResult('supplyResult',
            `‚úÖ Key Test Successful!\n\n${JSON.stringify(result, null, 2)}`,
            'success'
          );
        } else {
          showResult('supplyResult',
            `‚ùå Key Test Failed!\n\n${JSON.stringify(result, null, 2)}`,
            'error'
          );
        }

      } catch (error) {
        showResult('supplyResult',
          `‚ùå Test Failed\n\n${error.message}`,
          'error'
        );
      }
    }

    // Auto-run tests on page load
    document.addEventListener('DOMContentLoaded', function () {
      console.log('üß™ Test page loaded');
      console.log('Available classes:', {
        SupabaseKeyManager: typeof SupabaseKeyManager,
        UserAnalytics: typeof UserAnalytics,
        SupplyKeyUtils: typeof window.SupplyKeyUtils
      });
    });
  </script>
</body>

</html>