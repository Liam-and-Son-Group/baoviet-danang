<!DOCTYPE html>
<html>

<head>
  <title>üîç Debug Deploy System</title>
  <style>
    body {
      font-family: monospace;
      margin: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .section {
      background: #2a2a2a;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .status {
      padding: 10px;
      margin: 5px 0;
      border-radius: 3px;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
    }

    .info {
      background: #d1ecf1;
      color: #0c5460;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 3px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
    }

    .log {
      background: #000;
      color: #00ff00;
      padding: 10px;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîç Debug Deploy System</h1>

    <div class="section">
      <h3>üìã Configuration</h3>
      <p><strong>Supabase URL:</strong> <span id="supabaseUrl">Loading...</span></p>
      <p><strong>Project Ref:</strong> <span id="projectRef">Loading...</span></p>
      <p><strong>Edge Function URL:</strong> <span id="functionUrl">Loading...</span></p>
    </div>

    <div class="section">
      <h3>üß™ Tests</h3>
      <button onclick="testSupabaseConnection()">1. Test Supabase Connection</button>
      <button onclick="testEdgeFunction()">2. Test Edge Function</button>
      <button onclick="testGitHubAPI()">3. Test GitHub API</button>
      <button onclick="testFullWorkflow()">4. Test Full Workflow</button>
      <button onclick="checkLogs()">5. Check Logs</button>
    </div>

    <div class="section">
      <h3>üìä Results</h3>
      <div id="status"></div>
    </div>

    <div class="section">
      <h3>üìù Console Logs</h3>
      <div id="logs" class="log"></div>
    </div>

    <div class="section">
      <h3>‚öôÔ∏è Manual GitHub Token Test</h3>
      <textarea id="githubToken" placeholder="Paste your GitHub token here (ghp_...)"></textarea>
      <button onclick="testGitHubWithToken()">Test GitHub with Token</button>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase (replace with your actual credentials)
    const SUPABASE_URL = 'https://your-project-ref.supabase.co';
    const SUPABASE_ANON_KEY = 'your-anon-key';

    let client;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.getElementById('logs');
      logDiv.innerHTML += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;

      const statusDiv = document.getElementById('status');
      const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
      statusDiv.innerHTML += `<div class="status ${statusClass}">${message}</div>`;

      console.log(message);
    }

    async function initialize() {
      try {
        // Try to get config from localStorage or prompt
        let supabaseUrl = localStorage.getItem('supabase_url') || prompt('Enter Supabase URL:');
        let supabaseKey = localStorage.getItem('supabase_key') || prompt('Enter Supabase Anon Key:');

        if (supabaseUrl && supabaseKey) {
          localStorage.setItem('supabase_url', supabaseUrl);
          localStorage.setItem('supabase_key', supabaseKey);

          client = supabase.createClient(supabaseUrl, supabaseKey);

          // Extract project ref
          const projectRef = supabaseUrl.match(/https:\/\/([^.]+)\.supabase\.co/)[1];

          document.getElementById('supabaseUrl').textContent = supabaseUrl;
          document.getElementById('projectRef').textContent = projectRef;
          document.getElementById('functionUrl').textContent = `${supabaseUrl}/functions/v1/deploy-article`;

          log('‚úÖ Initialized successfully', 'success');
        } else {
          log('‚ùå Missing Supabase credentials', 'error');
        }
      } catch (error) {
        log(`‚ùå Initialization failed: ${error.message}`, 'error');
      }
    }

    async function testSupabaseConnection() {
      try {
        log('üîç Testing Supabase connection...');

        const { data, error } = await client.from('articles').select('id').limit(1);

        if (error) {
          throw error;
        }

        log(`‚úÖ Supabase connection OK. Found ${data.length} articles.`, 'success');
        return true;
      } catch (error) {
        log(`‚ùå Supabase connection failed: ${error.message}`, 'error');
        return false;
      }
    }

    async function testEdgeFunction() {
      try {
        log('üîç Testing Edge Function...');

        // Get a test article ID
        const { data: articles } = await client.from('articles').select('id, filename').limit(1);

        if (!articles || articles.length === 0) {
          throw new Error('No articles found to test with');
        }

        const testArticleId = articles[0].id;
        log(`üìÑ Using test article: ${articles[0].filename} (${testArticleId})`);

        const { data, error } = await client.functions.invoke('deploy-article', {
          body: {
            article_id: testArticleId,
            trigger_source: 'debug_test'
          }
        });

        if (error) {
          throw error;
        }

        log(`‚úÖ Edge Function response: ${JSON.stringify(data)}`, 'success');
        return true;
      } catch (error) {
        log(`‚ùå Edge Function failed: ${error.message}`, 'error');

        if (error.message.includes('not found') || error.message.includes('404')) {
          log('üí° Edge Function ch∆∞a ƒë∆∞·ª£c deploy. Ch·∫°y: supabase functions deploy deploy-article', 'warning');
        }

        return false;
      }
    }

    async function testGitHubAPI() {
      try {
        log('üîç Testing GitHub API...');

        // This will test through Edge Function
        const result = await testEdgeFunction();

        if (result) {
          log('üìä Check GitHub Actions: https://github.com/Liam-and-Son-Group/baoviet-danang/actions', 'info');
        }

        return result;
      } catch (error) {
        log(`‚ùå GitHub API test failed: ${error.message}`, 'error');
        return false;
      }
    }

    async function testGitHubWithToken() {
      try {
        const token = document.getElementById('githubToken').value.trim();

        if (!token) {
          throw new Error('Please enter GitHub token');
        }

        log('üîç Testing GitHub API with manual token...');

        const payload = {
          event_type: 'new-article-created',
          client_payload: {
            article_id: 'test-id',
            article_filename: 'test.html',
            article_title: 'Test Article',
            trigger_source: 'manual_test'
          }
        };

        const response = await fetch(
          'https://api.github.com/repos/Liam-and-Son-Group/baoviet-danang/dispatches',
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          }
        );

        if (response.status === 204) {
          log('‚úÖ GitHub API call successful! Check Actions tab.', 'success');
          log('üìä GitHub Actions: https://github.com/Liam-and-Son-Group/baoviet-danang/actions', 'info');
        } else {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

      } catch (error) {
        log(`‚ùå GitHub API test failed: ${error.message}`, 'error');
      }
    }

    async function testFullWorkflow() {
      log('üöÄ Starting full workflow test...');

      const tests = [
        { name: 'Supabase Connection', fn: testSupabaseConnection },
        { name: 'Edge Function', fn: testEdgeFunction },
        { name: 'GitHub API', fn: testGitHubAPI }
      ];

      for (const test of tests) {
        log(`\n--- Testing ${test.name} ---`);
        const result = await test.fn();
        if (!result) {
          log(`‚ùå Full workflow stopped at: ${test.name}`, 'error');
          return;
        }
      }

      log('üéâ Full workflow test completed!', 'success');
    }

    async function checkLogs() {
      try {
        log('üìä Checking webhook logs...');

        const { data, error } = await client
          .from('webhook_logs')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) {
          throw error;
        }

        if (data.length === 0) {
          log('‚ö†Ô∏è No webhook logs found. Edge Function may not be working.', 'warning');
        } else {
          log(`üìä Found ${data.length} webhook logs:`, 'info');
          data.forEach(log_entry => {
            const time = new Date(log_entry.created_at).toLocaleString();
            log(`  [${time}] ${log_entry.event_type} - ${log_entry.status}`);
          });
        }

      } catch (error) {
        log(`‚ùå Failed to check logs: ${error.message}`, 'error');
      }
    }

    // Initialize when page loads
    window.onload = initialize;
  </script>
</body>

</html>